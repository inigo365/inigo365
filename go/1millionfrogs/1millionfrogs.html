<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>1millionfrogs</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<link rel="icon" type="image/png" href="../../images/icon.png">

<style>
@font-face{
  font-family:"RuneScape UF";
  src:url("../../fonts/RuneScape-UF.woff2") format("woff2"),
      url("../../fonts/RuneScape-UF.woff") format("woff");
}

html{ background:#fff; height:100%; }
body{ background:#fff; min-height:100%; }

html,body{
  margin:0; padding:0; width:100%;
  height:100vh; height:100svh; height:100dvh;
  font-family:"RuneScape UF", Arial, sans-serif;
  -webkit-user-select:none; user-select:none;
  -webkit-touch-callout:none;
  -webkit-tap-highlight-color:transparent;
  -webkit-text-size-adjust:100%;
  touch-action:manipulation;
}
html, body { cursor: url("../../images/cursor/cursor.png"), auto; }
button, input { cursor: url("../../images/cursor/cursor-hover.png"), pointer; }

:root{ --accent:#2d93ea; --btn:#000; }

#c{
  position:fixed; inset:0; display:block;
  /* IMPORTANT for iOS: gives smoother continuous finger control */
  touch-action:none;
}

/* ===== UI ===== */
.topbar{
  position:fixed; top:8px; left:8px; right:8px;
  display:flex; align-items:flex-start; justify-content:flex-start;
  gap:10px; z-index:20; pointer-events:none;
}
.back-button{
  pointer-events:auto;
  font-size:28px; background:transparent; border:none;
  color:var(--accent);
  font-family:"RuneScape UF", Arial, sans-serif;
  text-transform:lowercase; padding:0;
}
.back-button:hover{ text-decoration:underline; }

.panel{
  pointer-events:auto;
  border:2px solid #000; background:#fff;
  padding:10px 12px;
  width:min(560px, calc(100vw - 120px));
}
.panel-title{ font-size:26px; text-transform:lowercase; margin-bottom:6px; }
.panel-sub{ font-size:18px; text-transform:lowercase; line-height:1.25; }

.row{
  margin-top:8px;
  display:flex; align-items:center; justify-content:space-between;
  gap:10px; flex-wrap:wrap;
}
.linkish{
  font-family:"RuneScape UF", Arial, sans-serif;
  background:transparent; border:none; color:var(--btn);
  font-size:22px; padding:0; text-transform:lowercase;
}
.linkish:hover{ text-decoration:underline; }
.stat{ font-size:18px; text-transform:lowercase; font-variant-numeric:tabular-nums; }

/* ===== Leaderboard (always show top 5 + you if outside) ===== */
.leaderboard{
  pointer-events:none;
  position:fixed;
  top:8px;
  right:8px;
  border:2px solid #000;
  background:#fff;
  padding:10px 12px;
  width:min(280px, calc(100vw - 16px));
  z-index:19;
}
.lb-title{ font-size:22px; text-transform:lowercase; margin-bottom:6px; }
.lb-row{
  display:flex;
  justify-content:space-between;
  gap:10px;
  font-size:18px;
  text-transform:lowercase;
  line-height:1.25;
}
.lb-row .name{
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width:175px;
}
.lb-row.you{
  font-weight:700;
  text-decoration:underline;
}
.lb-sep{
  height:6px;
}

/* ===== Name overlay ===== */
.overlay{
  position:fixed; inset:0;
  background: rgba(255,255,255,0.98);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.panel2{
  width:min(640px, calc(100vw - 24px));
  border:2px solid #000;
  padding:16px;
  background:#fff;
  text-align:center;
}
.panel2-title{ font-size:30px; text-transform:lowercase; margin-bottom:10px; }
.panel2-sub{
  font-size:18px;
  text-transform:lowercase;
  line-height:1.35;
  margin-bottom:12px;
}
.name-row{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  align-items:center;
}
.name-row input{
  font-family:"RuneScape UF", Arial, sans-serif;
  font-size:22px;
  padding:8px 12px;
  border:2px solid #000;
  background:#fff;
  outline:none;
  border-radius:0;
  -webkit-appearance:none;
  appearance:none;
  text-transform:lowercase;
  width:min(320px, calc(100vw - 160px));
}
.boxbtn{
  font-family:"RuneScape UF", Arial, sans-serif;
  font-size:20px;
  padding:8px 14px;
  border:2px solid #000;
  background:#fff;
  text-transform:lowercase;
  color:var(--btn);
}
.hint{
  margin-top:10px;
  font-size:16px;
  text-transform:lowercase;
  opacity:0.9;
}

/* ===== Music toggle ===== */
.music-toggle{
  position:fixed;
  left:8px;
  bottom:8px;
  z-index:25;
  font-family:"RuneScape UF", Arial, sans-serif;
  font-size:20px;
  padding:6px 10px;
  border:2px solid #000;
  background:#fff;
  text-transform:lowercase;
  color:var(--btn);
}
.music-toggle:hover{ text-decoration:underline; }

/* ===== Mobile layout fixes (prevents panels stacking/overlapping) ===== */
@media (max-width: 760px){
  .topbar{
    flex-direction:column;
    align-items:flex-start;
    right:8px;
  }
  .panel{
    width: calc(100vw - 16px);
  }
  .leaderboard{
    top: 148px;     /* sits under the main panel instead of overlaying it */
    right:8px;
    width: calc(100vw - 16px);
  }
}
</style>
</head>

<body>
<canvas id="c"></canvas>

<div class="topbar">
  <button class="back-button" id="backBtn">← back</button>

  <div class="panel">
    <div class="panel-title">1millionfrogs</div>
    <div class="panel-sub">
      keep finger down to steer (ios smooth)<br>
      boost: space (desktop) • two fingers (mobile)
    </div>
    <div class="row">
      <button class="linkish" id="resetBtn" type="button">reset</button>
      <div class="stat" id="stats">length: 0 • eaten: 0 • boost: off</div>
    </div>
  </div>
</div>

<div class="leaderboard" id="leaderboard">
  <div class="lb-title">leaderboard (length)</div>
  <div id="lbList"></div>
</div>

<div class="overlay" id="nameOverlay" aria-hidden="false">
  <div class="panel2" role="dialog" aria-modal="true" aria-label="name entry">
    <div class="panel2-title">enter name</div>
    <div class="panel2-sub">there are big frogs out there already. catch them.</div>
    <div class="name-row">
      <input id="nameInput" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" placeholder="name">
      <button class="boxbtn" id="startBtn" type="button">start</button>
    </div>
    <div class="hint">tip: boosting sheds mass behind you</div>
  </div>
</div>

<button class="music-toggle" id="musicBtn" type="button">music: on</button>

<script>
/* iOS pinch prevention + no context menu */
document.addEventListener("gesturestart", (e) => e.preventDefault(), { passive:false });
document.addEventListener("gesturechange", (e) => e.preventDefault(), { passive:false });
document.addEventListener("gestureend", (e) => e.preventDefault(), { passive:false });
document.addEventListener("contextmenu", e => e.preventDefault());

const c = document.getElementById("c");
const ctx = c.getContext("2d", { alpha:false });

const statsEl = document.getElementById("stats");
const lbList = document.getElementById("lbList");

document.getElementById("backBtn").addEventListener("click", () => history.back());

/* =========================================================
   ASSETS (relative to THIS HTML file)

   Put these here:
     inigo365/go/1millionfrogs/assets/realm1.jpg
     inigo365/go/1millionfrogs/assets/mask.png
     inigo365/go/1millionfrogs/assets/1millionfrogs.mp3
========================================================= */
const BG_SRC = "assets/realm1.jpg";
const TOYOTA_SRC = "assets/mask.png";
const MUSIC_SRC = "assets/1millionfrogs.mp3";

/* =========================================================
   SETTINGS (kept lean for performance)
========================================================= */
const SETTINGS = {
  bots: 6,
  starterGiants: 3,
  pelletTarget: 650,

  segSpacing: 12,
  maxSegPoints: 220,

  baseSpeed: 175,
  turnSmooth: 10.0,

  boostSpeedMul: 1.55,
  boostDrainPerSec: 52,
  boostDropEvery: 0.13,

  headBodyHitMul: 0.85,
  cellSize: 110,
};

/* =========================================================
   CANVAS
========================================================= */
let dpr=1, W=0, H=0;
function resize(){
  dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  W = innerWidth; H = innerHeight;
  c.width = Math.floor(W*dpr);
  c.height = Math.floor(H*dpr);
  c.style.width = W+"px";
  c.style.height = H+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener("resize", resize);
resize();

/* =========================================================
   IMAGES
========================================================= */
const bgImg = new Image();
bgImg.decoding = "async";
bgImg.src = BG_SRC;

const toyotaImg = new Image();
toyotaImg.decoding = "async";
toyotaImg.src = TOYOTA_SRC;

/* =========================================================
   MUSIC (loops; starts on first gesture; toggle)
========================================================= */
const musicBtn = document.getElementById("musicBtn");
const music = new Audio(MUSIC_SRC);
music.loop = true;
music.preload = "auto";
music.volume = 0.9;

let musicOn = true;
let musicUnlocked = false;

function updateMusicButton(){ musicBtn.textContent = musicOn ? "music: on" : "music: off"; }

async function tryStartMusic(){
  if(!musicOn) return;
  try{
    const p = music.play();
    if(p && typeof p.then === "function") await p;
    musicUnlocked = true;
  }catch{}
}

function unlockAudio(){
  if(musicUnlocked) return;
  tryStartMusic();
}

function setMusic(on){
  musicOn = !!on;
  updateMusicButton();
  if(!musicOn){
    try{ music.pause(); }catch{}
  } else {
    tryStartMusic();
  }
}

musicBtn.addEventListener("pointerdown", (e)=>{
  e.preventDefault();
  unlockAudio();
  setMusic(!musicOn);
});

// keep trying until iOS allows it
window.addEventListener("pointerdown", unlockAudio, { capture:true });
window.addEventListener("touchstart", unlockAudio, { capture:true, passive:true });
window.addEventListener("keydown", unlockAudio, { capture:true });

updateMusicButton();

/* =========================================================
   BOT NAMES (no numbers)
========================================================= */
const FROG_NAMES = [
  "sir croaks-a-lot","lady lily","moss wizard","pond prophet","bog baron",
  "tadpole tycoon","ribbit mcgee","hops mcgloats","toadstool oracle","lilypad duchess",
  "swamp prince","mud maven","marshmallow toad","feral frogling","croak noir",
  "mr blorbo","slime saint","kermits cousin","the damp one","frog of war",
  "bloop pope","green accountant","soggy knight","mystic gunk","hollow croak",
  "fizz bishop","lilypad librarian","glorp champion","gumbo ghost","muck angel",
  "pondwraith","bog gossiper","croak whisperer","moss boss","wet prophet",
  "springleaf","dungeon tad","the polite toad","swamp couture","ribbit rex",
  "mild menace","drippy duke","marsh mirage","chonk toad","slurp wizard",
  "frogbeard","inkblot frog","silt emperor","mire cherub","glitter toad"
];
function pickName(used){
  for(let i=0;i<16;i++){
    const n = FROG_NAMES[(Math.random()*FROG_NAMES.length)|0];
    if(!used.has(n)) return n;
  }
  return FROG_NAMES[(Math.random()*FROG_NAMES.length)|0];
}

/* =========================================================
   SPRITES (cached)
========================================================= */
function makeFrogSprite(size, variant){
  const s = document.createElement("canvas");
  s.width = s.height = size;
  const g = s.getContext("2d");

  const cx = size/2, cy = size/2, r = size*0.33;

  g.beginPath();
  g.arc(cx, cy, r, 0, Math.PI*2);
  g.fillStyle = (variant === "gold") ? "rgba(255, 215, 0, 0.95)" : "rgba(55, 180, 90, 0.95)";
  g.fill();

  g.lineWidth = Math.max(2, size*0.05);
  g.strokeStyle = "rgba(0,0,0,0.35)";
  g.stroke();

  const ex = size*0.18, ey = size*0.18, er = size*0.09;
  g.beginPath();
  g.arc(cx - ex, cy - ey, er, 0, Math.PI*2);
  g.arc(cx + ex, cy - ey, er, 0, Math.PI*2);
  g.fillStyle = "rgba(240,240,240,0.95)";
  g.fill();
  g.strokeStyle = "rgba(0,0,0,0.30)";
  g.stroke();

  const pr = er*0.35;
  g.beginPath();
  g.arc(cx - ex, cy - ey, pr, 0, Math.PI*2);
  g.arc(cx + ex, cy - ey, pr, 0, Math.PI*2);
  g.fillStyle = "rgba(0,0,0,0.75)";
  g.fill();

  g.beginPath();
  g.arc(cx, cy + size*0.08, size*0.12, 0, Math.PI, false);
  g.strokeStyle = "rgba(0,0,0,0.25)";
  g.lineWidth = Math.max(2, size*0.03);
  g.stroke();

  if(variant === "gold"){
    g.save();
    g.globalAlpha = 0.9;
    g.strokeStyle = "rgba(255,255,255,0.9)";
    g.lineWidth = Math.max(2, size*0.035);
    const sx = size*0.22, sy = size*0.22;
    g.beginPath();
    g.moveTo(cx, sy); g.lineTo(cx, size-sy);
    g.moveTo(sx, cy); g.lineTo(size-sx, cy);
    g.stroke();
    g.restore();
  }

  return s;
}

function makeCrownSprite(size){
  const s = document.createElement("canvas");
  s.width = s.height = size;
  const g = s.getContext("2d");

  const pad = size*0.14, left = pad, right = size - pad;
  const top = size*0.20, baseY = size*0.74;

  g.fillStyle = "rgba(255, 215, 0, 0.95)";
  g.strokeStyle = "rgba(0,0,0,0.35)";
  g.lineWidth = Math.max(2, size*0.05);

  g.beginPath();
  g.moveTo(left, baseY);
  g.lineTo(left + (right-left)*0.20, top + (baseY-top)*0.35);
  g.lineTo(left + (right-left)*0.35, top);
  g.lineTo(left + (right-left)*0.50, top + (baseY-top)*0.32);
  g.lineTo(left + (right-left)*0.65, top);
  g.lineTo(left + (right-left)*0.80, top + (baseY-top)*0.35);
  g.lineTo(right, baseY);
  g.closePath();
  g.fill();
  g.stroke();

  g.beginPath();
  g.roundRect(left, baseY - size*0.16, right-left, size*0.18, size*0.05);
  g.fillStyle = "rgba(255, 200, 0, 0.95)";
  g.fill();
  g.stroke();

  g.fillStyle = "rgba(45, 147, 234, 0.9)";
  const gemR = size*0.05;
  g.beginPath();
  g.arc(left + (right-left)*0.33, baseY - size*0.10, gemR, 0, Math.PI*2);
  g.arc(left + (right-left)*0.50, baseY - size*0.10, gemR, 0, Math.PI*2);
  g.arc(left + (right-left)*0.67, baseY - size*0.10, gemR, 0, Math.PI*2);
  g.fill();

  return s;
}

const SPRITES = {
  pellet: makeFrogSprite(34, "normal"),
  pelletSmall: makeFrogSprite(26, "normal"),
  snake: makeFrogSprite(46, "normal"),
  snakeBig: makeFrogSprite(58, "normal"),
  snakeGold: makeFrogSprite(46, "gold"),
  snakeGoldBig: makeFrogSprite(58, "gold"),
  gold: makeFrogSprite(56, "gold"),
  crown: makeCrownSprite(56),
};

/* =========================================================
   INPUT (smooth iOS: first finger steers; 2 fingers boosts)
========================================================= */
let pointer = { x: W/2, y: H/2 };
let boostHeld = false;
let hasTouchSteer = false;

// Touch path (best on iOS)
c.addEventListener("touchstart", (e)=>{
  e.preventDefault();
  const t = e.touches[0];
  if(t){ pointer.x = t.clientX; pointer.y = t.clientY; hasTouchSteer = true; }
  boostHeld = e.touches.length >= 2;
}, { passive:false });

c.addEventListener("touchmove", (e)=>{
  e.preventDefault();
  const t = e.touches[0];
  if(t){ pointer.x = t.clientX; pointer.y = t.clientY; hasTouchSteer = true; }
  boostHeld = e.touches.length >= 2;
}, { passive:false });

c.addEventListener("touchend", (e)=>{
  e.preventDefault();
  boostHeld = e.touches.length >= 2;
  if(e.touches.length === 0) hasTouchSteer = false;
}, { passive:false });

c.addEventListener("touchcancel", (e)=>{
  e.preventDefault();
  boostHeld = false;
  hasTouchSteer = false;
}, { passive:false });

// Mouse/pen fallback
c.addEventListener("pointerdown", (e)=>{
  if(e.pointerType === "touch") return; // touch uses touch events above
  pointer.x = e.clientX; pointer.y = e.clientY;
  // mouse button held = boost (keeps previous behaviour)
  boostHeld = true;
});
c.addEventListener("pointermove", (e)=>{
  if(e.pointerType === "touch") return;
  pointer.x = e.clientX; pointer.y = e.clientY;
});
c.addEventListener("pointerup", (e)=>{
  if(e.pointerType === "touch") return;
  boostHeld = false;
});

// Keyboard boost
document.addEventListener("keydown", (e)=>{ if(e.key === " "){ boostHeld = true; e.preventDefault(); } });
document.addEventListener("keyup",   (e)=>{ if(e.key === " "){ boostHeld = false; e.preventDefault(); } });

/* =========================================================
   WORLD + RNG
========================================================= */
const WORLD = { seed: 1337, pellets: [] };
let golden = null;

function rand01(n){
  let x = (n ^ WORLD.seed) >>> 0;
  x = Math.imul(x ^ (x >>> 16), 2246822507);
  x = Math.imul(x ^ (x >>> 13), 3266489909);
  x = (x ^ (x >>> 16)) >>> 0;
  return x / 4294967296;
}
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function normAngle(a){
  while(a > Math.PI) a -= Math.PI*2;
  while(a < -Math.PI) a += Math.PI*2;
  return a;
}
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* =========================================================
   SPATIAL GRID
========================================================= */
function cellKey(cx, cy){ return (cx<<16) ^ (cy & 0xffff); }
class Grid {
  constructor(cellSize){ this.cs = cellSize; this.map = new Map(); }
  clear(){ this.map.clear(); }
  _bucket(cx, cy){
    const k = cellKey(cx, cy);
    let b = this.map.get(k);
    if(!b){ b = []; this.map.set(k,b); }
    return b;
  }
  add(x,y,obj){
    const cx = (x / this.cs) | 0;
    const cy = (y / this.cs) | 0;
    this._bucket(cx,cy).push(obj);
  }
  query(x,y,rad, out){
    const cs = this.cs;
    const minX = ((x-rad)/cs)|0, maxX = ((x+rad)/cs)|0;
    const minY = ((y-rad)/cs)|0, maxY = ((y+rad)/cs)|0;
    for(let cy=minY; cy<=maxY; cy++){
      for(let cx=minX; cx<=maxX; cx++){
        const b = this.map.get(cellKey(cx,cy));
        if(!b) continue;
        for(let i=0;i<b.length;i++) out.push(b[i]);
      }
    }
  }
}
const pelletGrid = new Grid(SETTINGS.cellSize);
const bodyGrid   = new Grid(SETTINGS.cellSize);

/* =========================================================
   SNAKES
========================================================= */
function makeSnake(opts){
  return {
    id: opts.id,
    name: opts.name,
    isPlayer: !!opts.isPlayer,
    alive: true,

    x: opts.x || 0,
    y: opts.y || 0,
    angle: 0,
    targetAngle: 0,

    baseSpeed: SETTINGS.baseSpeed * (opts.speedMul ?? 1),
    speed: SETTINGS.baseSpeed,

    eaten: opts.eaten || 0,
    length: opts.length || 120,
    radius: 10,

    body: [{x: opts.x || 0, y: opts.y || 0}],
    lastSegX: opts.x || 0,
    lastSegY: opts.y || 0,

    boost: false,
    boostDropT: 0,

    ai: {
      t: 0,
      targetX: 0,
      targetY: 0,
      wanderA: rand01(opts.id*999+11)*Math.PI*2
    }
  };
}
function updateRadius(s){ s.radius = clamp(10 + s.length / 190, 10, 34); }

const snakes = [];
let player = null;

function seedBody(s){
  const pts = Math.min(SETTINGS.maxSegPoints, Math.max(8, (s.length / SETTINGS.segSpacing)|0));
  const x = s.x, y = s.y;
  s.body = [];
  let px = x, py = y;
  let ang = rand01(s.id*99) * Math.PI*2;
  for(let k=0;k<pts;k++){
    s.body.push({x:px,y:py});
    ang += (rand01(s.id*123 + k*9)-0.5) * 0.35;
    px -= Math.cos(ang) * SETTINGS.segSpacing;
    py -= Math.sin(ang) * SETTINGS.segSpacing;
  }
  s.body[0] = {x,y};
  s.lastSegX = x;
  s.lastSegY = y;
}

function spawnPlayer(name){
  const s = makeSnake({
    id: 1,
    name: (name || "frog").toLowerCase().slice(0,18),
    isPlayer: true,
    x: 0, y: 0,
    length: 140,
    speedMul: 1.0
  });
  updateRadius(s);
  seedBody(s);
  player = s;
  snakes.push(s);
}

function spawnBots(count, baseId, lengthMin, lengthMax, speedMin, speedMax, usedNames){
  for(let i=0;i<count;i++){
    const id = baseId + i;
    const a  = rand01(id*17) * Math.PI*2;
    const r  = 650 + rand01(id*23)*1200;
    const x  = Math.cos(a)*r;
    const y  = Math.sin(a)*r;

    const len = lengthMin + rand01(id*31) * (lengthMax - lengthMin);
    const speedMul = speedMin + rand01(id*41) * (speedMax - speedMin);

    const nm = pickName(usedNames); usedNames.add(nm);

    const s = makeSnake({ id, name:nm, x, y, length:len, speedMul });
    s.eaten = Math.floor(len / 8);

    updateRadius(s);
    seedBody(s);
    snakes.push(s);
  }
}

function spawnWorldSnakes(){
  const used = new Set([player.name]);

  // big targets
  spawnBots(SETTINGS.starterGiants, 200, 980, 1450, 0.92, 1.02, used);

  // normal bots
  spawnBots(SETTINGS.bots, 100, 140, 420, 0.92, 1.12, used);
}

/* =========================================================
   PELLETS
========================================================= */
function ensurePellets(camX, camY){
  const target = SETTINGS.pelletTarget;
  const radius = 1750;

  while(WORLD.pellets.length < target){
    const i = WORLD.pellets.length + ((Math.random()*1e9)|0);
    const a = rand01(i+10) * Math.PI*2;
    const r = Math.sqrt(rand01(i+20)) * radius;
    const x = camX + Math.cos(a)*r + (rand01(i+30)-0.5)*180;
    const y = camY + Math.sin(a)*r + (rand01(i+40)-0.5)*180;

    if(!golden && rand01(i+50) > 0.9995){
      golden = { x, y, r: 26 };
      continue;
    }
    WORLD.pellets.push({ x, y, r: 16 });
  }

  const maxD = radius * 1.35;
  const maxD2 = maxD*maxD;

  // cull far
  let w=0;
  for(let i=0;i<WORLD.pellets.length;i++){
    const p = WORLD.pellets[i];
    const dx=p.x-camX, dy=p.y-camY;
    if(dx*dx+dy*dy < maxD2) WORLD.pellets[w++] = p;
  }
  WORLD.pellets.length = w;

  if(golden){
    const dx=golden.x-camX, dy=golden.y-camY;
    if(dx*dx+dy*dy > maxD2) golden = null;
  }
}

function rebuildPelletGrid(){
  pelletGrid.clear();
  for(let i=0;i<WORLD.pellets.length;i++){
    pelletGrid.add(WORLD.pellets[i].x, WORLD.pellets[i].y, WORLD.pellets[i]);
  }
  if(golden) pelletGrid.add(golden.x, golden.y, golden);
}

/* =========================================================
   BODY
========================================================= */
function addBodyPointIfNeeded(s){
  const dx = s.x - s.lastSegX;
  const dy = s.y - s.lastSegY;
  if(Math.hypot(dx,dy) < SETTINGS.segSpacing) return;

  s.lastSegX = s.x;
  s.lastSegY = s.y;
  s.body.unshift({x:s.x,y:s.y});
  if(s.body.length > SETTINGS.maxSegPoints) s.body.length = SETTINGS.maxSegPoints;
}

function trimBodyToLength(s){
  const b = s.body;
  const target = s.length;

  while(b.length > 2){
    let t = 0;
    for(let i=0;i<b.length-1;i++){
      const p=b[i], q=b[i+1];
      t += Math.hypot(p.x-q.x, p.y-q.y);
      if(t > target) break;
    }
    if(t <= target) break;
    b.pop();
  }
}

/* =========================================================
   MOVEMENT + BOOST
========================================================= */
function updateMovement(s, dt){
  if(!s.alive) return;

  let da = normAngle(s.targetAngle - s.angle);
  s.angle += da * Math.min(1, dt * SETTINGS.turnSmooth);

  if(s.isPlayer){
    // boost is: space (desktop) OR 2-finger touch OR mouse-held
    s.boost = boostHeld && s.length > 110;
  }

  const speedMul = s.boost ? SETTINGS.boostSpeedMul : 1.0;
  s.speed = s.baseSpeed * speedMul;

  s.x += Math.cos(s.angle) * s.speed * dt;
  s.y += Math.sin(s.angle) * s.speed * dt;

  if(s.boost){
    s.length = Math.max(70, s.length - SETTINGS.boostDrainPerSec * dt);

    s.boostDropT -= dt;
    if(s.boostDropT <= 0){
      s.boostDropT = SETTINGS.boostDropEvery;
      const bx = s.x - Math.cos(s.angle) * (s.radius * 2.3);
      const by = s.y - Math.sin(s.angle) * (s.radius * 2.3);
      WORLD.pellets.push({ x: bx, y: by, r: 16 });
      updateRadius(s);
    }
  }
}

/* =========================================================
   AI
========================================================= */
function aiUpdate(s, dt){
  s.ai.t -= dt;
  if(s.ai.t <= 0){
    s.ai.t = 0.25 + Math.random()*0.55;

    let tx = s.x + Math.cos(s.ai.wanderA)*420;
    let ty = s.y + Math.sin(s.ai.wanderA)*420;
    s.ai.wanderA += (Math.random()-0.5)*0.9;

    const n = WORLD.pellets.length;
    if(n > 0){
      let best=null, bestD2=Infinity;
      for(let i=0;i<18;i++){
        const p = WORLD.pellets[(Math.random()*n)|0];
        const dx=p.x-s.x, dy=p.y-s.y;
        const d2=dx*dx+dy*dy;
        if(d2 < bestD2){ bestD2=d2; best=p; }
      }
      if(best){ tx=best.x; ty=best.y; }
    }

    if(golden){
      const dx=golden.x-s.x, dy=golden.y-s.y;
      if(dx*dx+dy*dy < 1300*1300){ tx=golden.x; ty=golden.y; }
    }

    if(player && player.alive){
      const dx=player.x-s.x, dy=player.y-s.y;
      const d2=dx*dx+dy*dy;
      if(s.length > player.length*1.18 && d2 < 900*900 && Math.random() > 0.5){
        tx=player.x; ty=player.y;
      }
    }

    s.ai.targetX = tx;
    s.ai.targetY = ty;
    s.boost = (s.length > 260 && Math.random() > 0.985);
  }

  // avoid bigger heads
  let ax=0, ay=0;
  for(let i=0;i<snakes.length;i++){
    const o=snakes[i];
    if(o===s || !o.alive) continue;
    if(o.length < s.length*1.20) continue;
    const dx=s.x-o.x, dy=s.y-o.y;
    const d2=dx*dx+dy*dy;
    if(d2 < 520*520){
      const inv = 1/Math.max(1, Math.sqrt(d2));
      ax += dx*inv;
      ay += dy*inv;
    }
  }

  const vx = (s.ai.targetX - s.x) + ax*420;
  const vy = (s.ai.targetY - s.y) + ay*420;
  s.targetAngle = Math.atan2(vy, vx);
}

/* =========================================================
   EATING
========================================================= */
const tmpNear = [];
function eatCheck(s){
  if(!s.alive) return;

  tmpNear.length = 0;
  pelletGrid.query(s.x, s.y, 80 + s.radius, tmpNear);

  for(let i=tmpNear.length-1;i>=0;i--){
    const p = tmpNear[i];
    const dx=p.x-s.x, dy=p.y-s.y;
    const rr=(s.radius + (p.r||18))*0.85;
    if(dx*dx+dy*dy > rr*rr) continue;

    if(golden && p === golden){
      golden = null;
      s.eaten += 25;
      s.length += 240;
      updateRadius(s);
      continue;
    }

    p._dead = true;
    s.eaten++;
    s.length += 10;
    updateRadius(s);
  }
}

function compactPellets(){
  const arr = WORLD.pellets;
  let w=0;
  for(let i=0;i<arr.length;i++){
    const p=arr[i];
    if(p._dead){ p._dead=false; continue; }
    arr[w++] = p;
  }
  arr.length = w;
}

/* =========================================================
   COLLISION
========================================================= */
function rebuildBodyGrid(){
  bodyGrid.clear();
  for(let si=0; si<snakes.length; si++){
    const s=snakes[si];
    if(!s.alive) continue;
    const b=s.body;
    const start = Math.min(6, b.length);
    for(let i=start;i<b.length;i++){
      const pt=b[i];
      bodyGrid.add(pt.x, pt.y, { x:pt.x, y:pt.y, sid:s.id });
    }
  }
}

const tmpBodies = [];
function checkPop(s){
  if(!s.alive) return;

  // head-to-head
  for(let i=0;i<snakes.length;i++){
    const o=snakes[i];
    if(o===s || !o.alive) continue;
    const dx=o.x-s.x, dy=o.y-s.y;
    const rr=(o.radius+s.radius)*0.85;
    if(dx*dx+dy*dy < rr*rr){
      if(s.length < o.length*0.98) return popSnake(s);
      if(o.length < s.length*0.98) popSnake(o);
    }
  }

  // head vs body points
  tmpBodies.length = 0;
  bodyGrid.query(s.x, s.y, 80 + s.radius, tmpBodies);

  const hitR = s.radius * SETTINGS.headBodyHitMul;
  const hitR2 = hitR*hitR;

  for(let i=0;i<tmpBodies.length;i++){
    const pt = tmpBodies[i];
    if(pt.sid === s.id) continue;
    const dx=pt.x-s.x, dy=pt.y-s.y;
    if(dx*dx+dy*dy < hitR2) return popSnake(s);
  }
}

function popSnake(s){
  if(!s.alive) return;
  s.alive = false;

  const b=s.body;
  for(let i=0;i<b.length;i+=2){
    const pt=b[i];
    WORLD.pellets.push({ x:pt.x, y:pt.y, r:16 });
  }
  respawnSnake(s);
}

function respawnSnake(s){
  const baseX = player ? player.x : 0;
  const baseY = player ? player.y : 0;
  const a = Math.random()*Math.PI*2;
  const r = 420 + Math.random()*900;

  s.x = baseX + Math.cos(a)*r;
  s.y = baseY + Math.sin(a)*r;
  s.angle = Math.random()*Math.PI*2;
  s.targetAngle = s.angle;

  s.length = Math.max(110, s.length * 0.72);
  updateRadius(s);
  seedBody(s);

  s.boost = false;
  s.boostDropT = 0;
  s.alive = true;
}

/* =========================================================
   CAMERA
========================================================= */
let cam = { x: 0, y: 0 };
function updateCamera(dt){
  if(!player) return;
  cam.x += (player.x - cam.x) * (1 - Math.pow(0.001, dt));
  cam.y += (player.y - cam.y) * (1 - Math.pow(0.001, dt));
}

/* =========================================================
   #1 MOMENT: one-time yaris flash + golden chain + crown
========================================================= */
let isNumberOne = false;

let yarisShownOnce = false;
let yarisActive = false;
let yarisStartMs = 0;

const YARIS_FADE_IN_MS  = 700;
const YARIS_HOLD_MS     = 220;
const YARIS_FADE_OUT_MS = 650;

function setNumberOneState(on){
  const next = !!on;
  if(next && !isNumberOne){
    if(!yarisShownOnce){
      yarisShownOnce = true;
      yarisActive = true;
      yarisStartMs = performance.now();
    }
  }
  isNumberOne = next;
}

/* =========================================================
   DRAW
========================================================= */
function drawPinnedBackground(){
  ctx.fillStyle = "white";
  ctx.fillRect(0,0,W,H);

  if(bgImg.complete && bgImg.naturalWidth > 0){
    const iw = bgImg.naturalWidth, ih = bgImg.naturalHeight;
    const scale = Math.max(W/iw, H/ih);
    const dw = iw*scale, dh = ih*scale;
    const dx = (W - dw)/2;
    const dy = (H - dh)/2;
    ctx.drawImage(bgImg, dx, dy, dw, dh);
  }

  const g = ctx.createRadialGradient(W*0.5, H*0.42, 60, W*0.5, H*0.5, Math.max(W,H));
  g.addColorStop(0, "rgba(45, 147, 234, 0.07)");
  g.addColorStop(1, "rgba(255,255,255,0)");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);
}

function drawWorld(){
  const ox = W/2 - cam.x;
  const oy = H/2 - cam.y;

  // pellets
  for(let i=0;i<WORLD.pellets.length;i++){
    const p=WORLD.pellets[i];
    const sx=p.x+ox, sy=p.y+oy;
    if(sx<-40||sx>W+40||sy<-40||sy>H+40) continue;
    const spr = (p.r <= 14) ? SPRITES.pelletSmall : SPRITES.pellet;
    ctx.drawImage(spr, sx - spr.width/2, sy - spr.height/2);
  }

  // golden
  if(golden){
    const sx=golden.x+ox, sy=golden.y+oy;
    if(!(sx<-80||sx>W+80||sy<-80||sy>H+80)){
      const pulse = 0.55 + 0.45 * Math.sin(performance.now()*0.006);
      ctx.save();
      ctx.globalAlpha = 0.75 + pulse*0.25;
      ctx.drawImage(SPRITES.gold, sx - SPRITES.gold.width/2, sy - SPRITES.gold.height/2);
      ctx.restore();
    }
  }

  // snakes
  for(let si=0; si<snakes.length; si++){
    const s=snakes[si];
    if(!s.alive) continue;

    const b=s.body;
    const big = (s.radius > 22);
    const playerGold = (s.isPlayer && isNumberOne);
    const spr = playerGold
      ? (big ? SPRITES.snakeGoldBig : SPRITES.snakeGold)
      : (big ? SPRITES.snakeBig : SPRITES.snake);

    for(let i=b.length-1;i>=0;i--){
      const pt=b[i];
      const sx=pt.x+ox, sy=pt.y+oy;
      if(sx<-90||sx>W+90||sy<-90||sy>H+90) continue;

      ctx.drawImage(spr, sx - spr.width/2, sy - spr.height/2);

      if(i===0){
        ctx.font = `18px "RuneScape UF", Arial, sans-serif`;
        ctx.fillStyle = "black";
        ctx.textAlign = "center";
        ctx.textBaseline = "bottom";
        ctx.fillText(s.name, sx, sy - spr.height*0.55);

        if(playerGold){
          const crown = SPRITES.crown;
          ctx.drawImage(crown, sx - crown.width/2, sy - spr.height*0.95 - crown.height/2);
        }
      }
    }
  }
}

/* arrow pointing to #1 frog (hide when you have crown) */
function drawLeaderArrow(leader){
  if(!player || !leader) return;
  if(leader === player) return;     // crown = no arrow
  if(!player.alive || !leader.alive) return;

  const dx = leader.x - player.x;
  const dy = leader.y - player.y;
  const dist = Math.hypot(dx,dy);
  if(dist < 60) return;

  const ang = Math.atan2(dy,dx);

  // draw arrow near edge but inside UI margins
  const margin = 24;
  const cx = W/2, cy = H/2;

  // place at a radius from center, then clamp inside screen bounds
  const r = Math.min(W,H) * 0.38;
  let ax = cx + Math.cos(ang)*r;
  let ay = cy + Math.sin(ang)*r;

  ax = clamp(ax, margin, W-margin);
  ay = clamp(ay, margin, H-margin);

  ctx.save();
  ctx.translate(ax, ay);
  ctx.rotate(ang);

  // arrow body
  ctx.globalAlpha = 0.95;
  ctx.fillStyle = "rgba(45, 147, 234, 0.95)";
  ctx.strokeStyle = "rgba(0,0,0,0.35)";
  ctx.lineWidth = 2;

  ctx.beginPath();
  ctx.moveTo(14, 0);
  ctx.lineTo(-10, -10);
  ctx.lineTo(-6, 0);
  ctx.lineTo(-10, 10);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  // tiny distance hint
  ctx.rotate(-ang);
  ctx.font = `16px "RuneScape UF", Arial, sans-serif`;
  ctx.fillStyle = "black";
  ctx.textAlign = "center";
  ctx.textBaseline = "top";
  ctx.fillText(`#1`, 0, 12);

  ctx.restore();
}

function drawYarisFlash(){
  if(!yarisActive) return;
  if(!toyotaImg.complete || toyotaImg.naturalWidth <= 0) return;

  const now = performance.now();
  const t = now - yarisStartMs;
  const total = YARIS_FADE_IN_MS + YARIS_HOLD_MS + YARIS_FADE_OUT_MS;

  if(t >= total){
    yarisActive = false;
    return;
  }

  let a = 0;
  if(t < YARIS_FADE_IN_MS){
    const x = t / YARIS_FADE_IN_MS;
    a = x*x*(3-2*x);
  } else if(t < YARIS_FADE_IN_MS + YARIS_HOLD_MS){
    a = 1;
  } else {
    const u = (t - (YARIS_FADE_IN_MS + YARIS_HOLD_MS)) / YARIS_FADE_OUT_MS;
    const x = clamp(u, 0, 1);
    const s = x*x*(3-2*x);
    a = 1 - s;
  }

  const iw = toyotaImg.naturalWidth;
  const ih = toyotaImg.naturalHeight;

  const pad = 110;
  const maxW = Math.max(240, W - pad*2);
  const maxH = Math.max(240, H - pad*2);
  const scale = Math.min(maxW/iw, maxH/ih);

  const dw = iw*scale, dh = ih*scale;
  const x = (W - dw)/2, y = (H - dh)/2;

  ctx.save();
  ctx.globalAlpha = 0.95 * a;
  ctx.drawImage(toyotaImg, x, y, dw, dh);
  ctx.restore();
}

/* =========================================================
   LEADERBOARD: ALWAYS show top 5, plus "you" if outside top 5
========================================================= */
let leader = null;
let lbTimer = 0;

function renderLBRow(rank, s, isYou){
  const row = document.createElement("div");
  row.className = "lb-row" + (isYou ? " you" : "");
  row.innerHTML = `
    <div class="name">${rank}) ${escapeHtml(s.name)}</div>
    <div>${Math.round(s.length)}</div>
  `;
  return row;
}

function renderPlaceholderRow(rank){
  const row = document.createElement("div");
  row.className = "lb-row";
  row.innerHTML = `<div class="name">${rank}) —</div><div>—</div>`;
  return row;
}

function updateLeaderboard(dt){
  lbTimer -= dt;
  if(lbTimer > 0) return;
  lbTimer = 0.25;

  const alive = snakes.filter(s=>s.alive).slice();
  alive.sort((a,b)=> b.length - a.length);

  leader = alive[0] || null;

  // #1 state (for crown / yaris)
  if(player && player.alive && leader){
    setNumberOneState(leader === player);
  } else {
    setNumberOneState(false);
  }

  lbList.innerHTML = "";

  // top 5 ALWAYS (fill with placeholders if needed)
  for(let i=0;i<5;i++){
    const s = alive[i];
    if(s) lbList.appendChild(renderLBRow(i+1, s, (player && s === player)));
    else lbList.appendChild(renderPlaceholderRow(i+1));
  }

  // add you if outside top 5
  if(player && player.alive){
    const idx = alive.indexOf(player);
    const rank = idx >= 0 ? idx + 1 : null;
    if(rank && rank > 5){
      const sep = document.createElement("div");
      sep.className = "lb-sep";
      lbList.appendChild(sep);
      lbList.appendChild(renderLBRow(rank, player, true));
    }
  }
}

/* =========================================================
   LOOP
========================================================= */
let last = performance.now();

function tick(now){
  const dt = Math.min(0.033, (now - last)/1000);
  last = now;

  // steering:
  // - on touch: frog moves toward where finger is on screen (continuous)
  // - on desktop: frog moves toward pointer location
  if(player && player.alive){
    const dx = pointer.x - W/2;
    const dy = pointer.y - H/2;
    player.targetAngle = Math.atan2(dy, dx);
  }

  // AI
  for(let i=0;i<snakes.length;i++){
    const s=snakes[i];
    if(!s.alive) continue;
    if(!s.isPlayer) aiUpdate(s, dt);
  }

  // move + body
  for(let i=0;i<snakes.length;i++){
    const s=snakes[i];
    if(!s.alive) continue;
    updateMovement(s, dt);
    addBodyPointIfNeeded(s);
    trimBodyToLength(s);
  }

  // camera
  updateCamera(dt);

  // pellets + grids
  ensurePellets(cam.x, cam.y);
  rebuildPelletGrid();
  rebuildBodyGrid();

  // eating
  for(let i=0;i<snakes.length;i++){
    const s=snakes[i];
    if(!s.alive) continue;
    eatCheck(s);
  }
  compactPellets();

  // collisions
  for(let i=0;i<snakes.length;i++){
    const s=snakes[i];
    if(!s.alive) continue;
    checkPop(s);
  }

  // leaderboard + leader ref
  updateLeaderboard(dt);

  // draw
  drawPinnedBackground();
  drawWorld();
  drawLeaderArrow(leader);
  drawYarisFlash();

  // ui
  if(player){
    const b = player.boost ? "on" : "off";
    statsEl.textContent = `length: ${Math.round(player.length)} • eaten: ${player.eaten.toLocaleString()} • boost: ${b}`;
  }

  requestAnimationFrame(tick);
}

/* =========================================================
   START / RESET
========================================================= */
const nameOverlay = document.getElementById("nameOverlay");
const nameInput = document.getElementById("nameInput");
const startBtn = document.getElementById("startBtn");

function startGame(){
  unlockAudio();
  tryStartMusic();

  WORLD.seed = (WORLD.seed + ((Math.random()*1e9)|0)) >>> 0;

  snakes.length = 0;
  WORLD.pellets.length = 0;
  golden = null;

  isNumberOne = false;
  yarisShownOnce = false;
  yarisActive = false;

  const nm = (nameInput.value || "frog").toLowerCase().trim().slice(0,18) || "frog";
  spawnPlayer(nm);
  spawnWorldSnakes();

  cam.x = player.x;
  cam.y = player.y;

  nameOverlay.style.display = "none";
  nameOverlay.setAttribute("aria-hidden","true");

  last = performance.now();
  requestAnimationFrame(tick);
}

startBtn.addEventListener("click", startGame);
nameInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") startGame(); });

document.getElementById("resetBtn").addEventListener("click", ()=>{
  nameOverlay.style.display = "flex";
  nameOverlay.setAttribute("aria-hidden","false");
  try{ nameInput.focus(); }catch{}
});

requestAnimationFrame(()=>{ try{ nameInput.focus(); }catch{} });
</script>
</body>
</html>
