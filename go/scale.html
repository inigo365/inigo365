<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>scale</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
@font-face {
  font-family: "RuneScape UF";
  src: url("../fonts/RuneScape-UF.woff2") format("woff2"),
       url("../fonts/RuneScape-UF.woff") format("woff");
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: white;
  font-family: "RuneScape UF", Arial, sans-serif;

  -webkit-user-select: none;
  -webkit-touch-callout: none;
  -webkit-tap-highlight-color: transparent;
  user-select: none;

  cursor: url("../images/cursor/cursor.png"), auto;
}

/* BACK BUTTON */
.back-button {
  position: fixed;
  top: 8px;
  left: 8px;
  font-size: 28px;
  background: transparent;
  border: none;
  color: #2d93ea;
  font-family: "RuneScape UF", Arial, sans-serif;
  cursor: url("../images/cursor/cursor-hover.png"), pointer;
  text-transform: lowercase;
  padding: 0;
  z-index: 10;
}

/* SCALE */
.scale-wrapper {
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: relative;
  z-index: 5;
}

.weight {
  font-size: 72px;
  color: #2d93ea;
  margin-bottom: 20px;
}

.instruction {
  font-size: 22px;
  color: #2d93ea;
}

/* GIF */
.scale-gif {
  position: absolute;
  bottom: 10%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1;
  display: none;
  max-width: 90%;
  pointer-events: none;
}
</style>
</head>

<body>

<button class="back-button" onclick="goBack()">← back</button>

<div class="scale-wrapper">
  <div class="weight" id="weight">0.0g</div>
  <div class="instruction">click &amp; hold to weigh</div>
</div>

<!-- GIF -->
<img src="scale.gif" alt="scale gif" id="scaleGif" class="scale-gif">

<!-- Optional MP3 -->
<audio id="scaleSound" src="scale.mp3" preload="auto"></audio>

<script>
let currentWeight = 0;
let holding = false;
let settleTimer = 0;
let justHitOneGram = false;
let userInteracted = false;

const weightEl = document.getElementById("weight");
const scaleGif = document.getElementById("scaleGif");
const scaleSound = document.getElementById("scaleSound");

function updateDisplay(jiggleX = 0, jiggleY = 0) {
  weightEl.textContent = currentWeight.toFixed(1) + "g";
  weightEl.style.transform = `translate(${jiggleX}px, ${jiggleY}px)`;
}

function animate() {
  let jiggleX = 0;
  let jiggleY = 0;

  if (holding) {
    if (currentWeight < 0.98) {
      currentWeight += (1 - currentWeight) * 0.04; // faster climb
      settleTimer = 0;
    } else {
      settleTimer += 1;
      // micro-jiggle ±0.1g around 1g
      if (Math.random() < 0.16) {
        const jiggleWeight = (Math.random() - 0.5) * 0.06;
        currentWeight = 1 + jiggleWeight;
        jiggleX = (Math.random() - 0.5) * 4;
        jiggleY = (Math.random() - 0.5) * 2;
      } else {
        currentWeight += (1 - currentWeight) * 0.05;
      }
      if (settleTimer > 120) currentWeight = 1;
    }

    // Show GIF as soon as 1g reached
    if (currentWeight >= 0.99) {
      scaleGif.style.display = "block";

      // Play MP3 once, only after user interaction (iOS-safe)
      if (!justHitOneGram && userInteracted) {
        scaleSound.currentTime = 0;
        scaleSound.play().catch(()=>{});
        justHitOneGram = true;
      }
    }

  } else {
    // Hide GIF on release
    scaleGif.style.display = "none";
    justHitOneGram = false;

    settleTimer = 0;
    currentWeight += (0 - currentWeight) * 0.15;
  }

  // Clamp weight
  if (currentWeight > 1.1) currentWeight = 1.1;
  if (!holding && currentWeight < 0.01) currentWeight = 0;

  updateDisplay(jiggleX, jiggleY);
  requestAnimationFrame(animate);
}

/* USER INTERACTION FOR IOS AUDIO */
function enableAudio() {
  if (!userInteracted) {
    scaleSound.play().then(() => scaleSound.pause()).catch(() => {});
    userInteracted = true;
    document.removeEventListener("touchstart", enableAudio);
    document.removeEventListener("mousedown", enableAudio);
  }
}
document.addEventListener("touchstart", enableAudio, { passive: true });
document.addEventListener("mousedown", enableAudio);

/* INPUT HANDLERS */
document.addEventListener("mousedown", () => holding = true);
document.addEventListener("mouseup", () => holding = false);
document.addEventListener("touchstart", () => holding = true, { passive: true });
document.addEventListener("touchend", () => holding = false, { passive: true });

/* NAVIGATION */
function goBack() {
  window.location.href = "index.html";
}

/* START ANIMATION */
animate();
</script>

</body>
</html>
