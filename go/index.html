<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>go</title>

<!-- iOS: stop zoom/double-tap zoom -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<link rel="icon" type="image/png" href="../images/icon.png">

<style>
@font-face {
  font-family: "RuneScape UF";
  src: url("../fonts/RuneScape-UF.woff2") format("woff2"),
       url("../fonts/RuneScape-UF.woff") format("woff");
}

/* Force white everywhere (helps iOS "grey" behind bounce) */
html { background: white; height: 100%; }
body { background: white; min-height: 100%; }

html, body {
  margin: 0;
  padding: 0;
  width: 100%;

  height: 100vh;
  height: 100svh;
  height: 100dvh;

  font-family: "RuneScape UF", Arial, sans-serif;

  -webkit-user-select: none;
  -webkit-touch-callout: none;
  -webkit-tap-highlight-color: transparent;
  user-select: none;

  touch-action: manipulation;
  -webkit-text-size-adjust: 100%;
}

html, body { cursor: url("../images/cursor/cursor.png"), auto; }
button, input { cursor: url("../images/cursor/cursor-hover.png"), pointer; }

button {
  -webkit-appearance: none;
  appearance: none;
  color: inherit;
}

:root{
  --accent: #2d93ea;  /* blue for nav/play/back */
  --btn: #000000;     /* black for UI buttons */
}

/* PASSWORD SCREEN */
.password-screen {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100vh;
  height: 100svh;
  height: 100dvh;
  background: white;
  transition: opacity 0.4s ease;
  position: relative;
}

.password-row {
  display: flex;
  align-items: flex-start;
  justify-content: center;
  gap: 14px;
  transform: translateX(0px);
}

.password-box {
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.password-box label {
  font-size: 32px;
  margin-bottom: 12px;
  display: block;
  cursor: url("../images/cursor/cursor.png"), auto;
}

.password-box input {
  font-family: "RuneScape UF", Arial, sans-serif;
  font-size: 24px;
  padding: 8px 12px;
  border: 2px solid black;
  background: white;
  outline: none;
  text-align: center;

  border-radius: 0;
  -webkit-appearance: none;
  appearance: none;
}

/* form + buttons */
#passwordForm {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

/* fixed slot so nothing shifts */
.action-row {
  width: 140px;
  height: 28px;
  line-height: 28px;
  text-align: center;
  position: relative;
}

/* ===== SMOOTH SWITCHING BASE ===== */
.switch-btn {
  font-family: "RuneScape UF", Arial, sans-serif;
  font-size: 24px;

  width: 140px;
  height: 28px;
  line-height: 28px;
  text-align: center;

  padding: 0;
  border: 0;
  background: transparent;
  text-transform: lowercase;
  color: var(--btn);

  position: absolute;
  inset: 0;

  /* smoother on iOS */
  will-change: opacity, transform;
  transform: translate3d(0, 2px, 0);
  opacity: 0;
  pointer-events: none;

  transition:
    opacity 120ms ease,
    transform 180ms cubic-bezier(.2,.9,.2,1);
}

.switch-btn.show {
  opacity: 1;
  pointer-events: auto;
  transform: translate3d(0, 0, 0);
}

.switch-btn:hover { text-decoration: underline; }

/* ENTER button (ONLY submits, never opens cheats) */
.enter-button { z-index: 2; }

/* HELP "?" button (ONLY opens cheats) */
.help-button { z-index: 1; }
.help-button.show { z-index: 3; } /* help above enter when help is shown */

/* Crisp "nope" flash */
.enter-button.flash {
  opacity: 1;
  transform: translate3d(0, 0, 0);
  animation: nopePulse 260ms ease both;
}

@keyframes nopePulse {
  0%   { opacity: 1; }
  45%  { opacity: .22; }
  100% { opacity: 1; }
}

/* ===== add to home page button (mobile only) ===== */
.add-home-btn {
  display: none; /* default hidden */
  position: fixed;
  left: 50%;
  bottom: 14px;
  transform: translateX(-50%);
  font-family: "RuneScape UF", Arial, sans-serif;
  font-size: 18px;
  padding: 0;
  border: 0;
  background: transparent;
  color: var(--btn);
  text-transform: lowercase;
  z-index: 20;
}
.add-home-btn:hover { text-decoration: underline; }

@media (max-width: 768px) {
  .add-home-btn { display: block; }
}

/* ===== overlays ===== */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(255, 255, 255, 0.98);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.panel {
  width: min(640px, calc(100vw - 24px));
  border: 2px solid black;
  padding: 16px;
  background: white;
  text-align: center;
  position: relative;
}

.panel-title {
  font-size: 30px;
  margin-bottom: 10px;
  text-transform: lowercase;
}

.panel-sub {
  font-size: 18px;
  margin-bottom: 12px;
}

/* footer row */
.panel-footer {
  margin-top: 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.linkish {
  font-family: "RuneScape UF", Arial, sans-serif;
  background: transparent;
  border: none;
  color: var(--btn);
  font-size: 22px;
  padding: 0;
  text-transform: lowercase;
  cursor: url("../images/cursor/cursor-hover.png"), pointer;
}
.linkish:hover { text-decoration: underline; }

.footer-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

/* boxed buttons */
.boxbtn {
  font-family: "RuneScape UF", Arial, sans-serif;
  font-size: 20px;
  padding: 8px 14px;
  border: 2px solid black;
  background: white;
  text-transform: lowercase;
  color: var(--btn);
  cursor: url("../images/cursor/cursor-hover.png"), pointer;
}

/* cheat entry UI */
.cheat-seq {
  font-size: 18px;
  border: 2px solid black;
  padding: 10px;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  flex-wrap: wrap;
}

.cheat-grid {
  margin-top: 12px;
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 10px;
  justify-items: center;
}

.cheat-btn {
  width: 100%;
  font-family: "RuneScape UF", Arial, sans-serif;
  font-size: 22px;
  padding: 10px 0;
  border: 2px solid black;
  background: white;
  text-transform: lowercase;
  color: var(--btn);
}

.cheat-actions {
  margin-top: 12px;
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
}

/* centered "?" info button under submit row */
.cheat-info-wrap {
  margin-top: 10px;
  display: flex;
  justify-content: center;
}

.cheat-info-q {
  font-family: "RuneScape UF", Arial, sans-serif;
  background: transparent;
  border: none;
  color: var(--btn);
  font-size: 24px;
  padding: 0;
  line-height: 1;
  cursor: url("../images/cursor/cursor-hover.png"), pointer;
}
.cheat-info-q:hover { text-decoration: underline; }

/* unlocked feedback */
.unlock-flash {
  font-size: 20px;
  margin-top: 10px;
  min-height: 22px;
  opacity: 0;
  transition: opacity 0.15s ease;
  text-transform: lowercase;
  color: var(--btn);
}
.unlock-flash.show { opacity: 1; }

/* vault list spaced evenly */
.vault-list {
  border: 2px solid black;
  padding: 18px 14px;
  min-height: 96px;
  display: flex;
  align-items: center;
  justify-content: space-evenly;
  font-size: 28px;
  text-transform: lowercase;
  gap: 28px;
}

/* clickable vault items */
.vault-item {
  padding: 0;
  border: 0;
  background: transparent;
  font: inherit;
  color: var(--btn);
  text-transform: lowercase;
}
button.vault-item:hover { text-decoration: underline; }

/* MINI POPUP */
.mini-overlay {
  position: fixed;
  inset: 0;
  background: rgba(255, 255, 255, 0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.mini-panel {
  width: min(520px, calc(100vw - 24px));
  border: 2px solid black;
  padding: 14px;
  background: white;
  text-align: center;
}

.mini-title {
  font-size: 26px;
  margin-bottom: 8px;
  text-transform: lowercase;
}

.mini-body {
  font-size: 18px;
  line-height: 1.35;
  text-transform: lowercase;
  margin-bottom: 12px;
}

.mini-body .code-line {
  display: block;
  margin: 6px 0;
}

/* Add-to-home panel visuals */
.home-steps {
  font-size: 18px;
  text-transform: lowercase;
  line-height: 1.4;
}
.home-step {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin: 8px 0;
  flex-wrap: wrap;
}
.share-icon {
  width: 22px;
  height: 22px;
  display: inline-block;
  vertical-align: middle;
}

/* CONTENT PAGE */
.content-page {
  display: none;
  width: 100%;
  height: 100vh;
  height: 100svh;
  height: 100dvh;
  background: white;
}

.content-wrapper {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

/* VIDEO */
.video-wrapper {
  position: relative;
  width: 100%;
  max-width: 854px;
  aspect-ratio: 854 / 480;
  background: white;
  opacity: 0;
  transition: opacity 1s ease;
  display: none;
}

video {
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}

@media (min-width: 1200px) {
  .video-wrapper { max-width: 1000px; }
}

/* MOBILE SCALE OVERRIDE */
@media (max-width: 768px) {
  .video-wrapper.mobile-fill {
    width: 100vw;
    max-width: none;
    height: calc(100vh - 56px);
    aspect-ratio: auto;
  }
}

/* PLAY BUTTON */
.play-button {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 52px;
  color: var(--accent);
  background: transparent;
  border: none;
  text-transform: lowercase;
  opacity: 0;
  transition: opacity 0.4s ease;
  z-index: 10;
  font-family: "RuneScape UF", Arial, sans-serif;
  pointer-events: none;
}

.play-button.show {
  opacity: 1;
  pointer-events: auto;
}

/* BACK BUTTON */
.back-button {
  position: fixed;
  top: 8px;
  left: 8px;
  font-size: 28px;
  background: transparent;
  border: none;
  color: var(--accent);
  font-family: "RuneScape UF", Arial, sans-serif;
  text-transform: lowercase;
  padding: 0;
  z-index: 10;
}

.back-button.show {
  opacity: 1;
}
</style>
</head>

<body>

<div class="password-screen" id="passwordScreen">
  <div class="password-row">
    <div class="password-box">
      <label>enter password:</label>

      <form id="passwordForm" autocomplete="off">
        <input
          type="password"
          id="passwordInput"
          autocomplete="off"
          autocapitalize="none"
          autocorrect="off"
          spellcheck="false"
          enterkeyhint="go"
        >

        <div class="action-row">
          <button type="submit" class="switch-btn enter-button" id="enterButton" aria-label="enter">enter ↵</button>
          <button type="button" class="switch-btn help-button" id="helpButton" aria-label="help">?</button>
        </div>
      </form>
    </div>
  </div>

  <button class="add-home-btn" id="addHomeBtn" type="button">add to home page</button>
</div>

<!-- CHEAT ENTRY OVERLAY -->
<div class="overlay" id="cheatOverlay" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" aria-label="enter code">
    <div class="panel-title">enter code:</div>
    <div class="panel-sub">tap buttons or use keyboard: arrows + a + b</div>

    <div class="cheat-seq" id="cheatSequence"></div>

    <div class="cheat-grid">
      <div></div>
      <button class="cheat-btn" data-token="U" type="button">↑</button>
      <div></div>

      <button class="cheat-btn" data-token="L" type="button">←</button>
      <button class="cheat-btn" data-token="D" type="button">↓</button>
      <button class="cheat-btn" data-token="R" type="button">→</button>

      <button class="cheat-btn" data-token="A" type="button">a</button>
      <button class="cheat-btn" data-token="B" type="button">b</button>
      <div></div>
    </div>

    <div class="cheat-actions">
      <button class="boxbtn" id="cheatClear" type="button">clear</button>
      <button class="boxbtn" id="cheatSubmit" type="button">submit</button>
    </div>

    <div class="unlock-flash" id="unlockFlash"></div>

    <div class="cheat-info-wrap">
      <button class="cheat-info-q" id="cheatInfo" type="button">?</button>
    </div>

    <div class="panel-footer">
      <button class="linkish" id="cheatToVault" type="button">code vault</button>
      <div class="footer-right">
        <button class="linkish" id="cheatClose" type="button">close</button>
      </div>
    </div>
  </div>
</div>

<!-- VAULT OVERLAY -->
<div class="overlay" id="vaultOverlay" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" aria-label="code vault">
    <div class="panel-title">code vault</div>
    <div class="panel-sub" id="vaultSub">unlocked passcodes appear here</div>

    <div class="vault-list" id="vaultList">—</div>

    <div class="panel-footer">
      <button class="linkish" id="vaultBack" type="button">back</button>
      <div class="footer-right">
        <button class="linkish" id="vaultClose" type="button">close</button>
      </div>
    </div>
  </div>
</div>

<!-- MINI POPUP -->
<div class="mini-overlay" id="miniOverlay" aria-hidden="true">
  <div class="mini-panel" role="dialog" aria-modal="true" aria-label="cheatcodes list">
    <div class="mini-title">cheatcodes</div>
    <div class="mini-body" id="miniBody">
      <span class="code-line">↑ ↑ ↓ ↓ ← → ← → b a</span>
      <span class="code-line">↑ ↓ ↑ ↓ a b</span>
      <span class="code-line">a b a b</span>
    </div>
    <button class="linkish" id="miniClose" type="button">close</button>
  </div>
</div>

<!-- Add-to-Home instructions overlay -->
<div class="overlay" id="homeOverlay" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" aria-label="add to home page">
    <div class="panel-title">add to home page</div>
    <div class="panel-sub" id="homeHow"></div>

    <div class="home-steps" id="homeSteps"></div>

    <div class="panel-footer">
      <div></div>
      <div class="footer-right">
        <button class="linkish" id="homeClose" type="button">close</button>
      </div>
    </div>
  </div>
</div>

<div class="content-page" id="contentPage">
  <div class="content-wrapper">
    <button class="back-button" id="backButton">← back</button>

    <div class="video-wrapper" id="videoWrapper">
      <video id="videoElement" playsinline disablePictureInPicture controlsList="nodownload nofullscreen noremoteplayback"></video>
    </div>

    <button class="play-button" id="playButton">play</button>
  </div>
</div>

<script>
/* iOS: prevent pinch-zoom gesture glitches */
document.addEventListener("gesturestart", (e) => e.preventDefault(), { passive: false });
document.addEventListener("gesturechange", (e) => e.preventDefault(), { passive: false });
document.addEventListener("gestureend", (e) => e.preventDefault(), { passive: false });

const passwordInput = document.getElementById("passwordInput");
const passwordForm = document.getElementById("passwordForm");
const enterButton = document.getElementById("enterButton");
const helpButton = document.getElementById("helpButton");

const passwordScreen = document.getElementById("passwordScreen");
const contentPage = document.getElementById("contentPage");
const playButton = document.getElementById("playButton");
const videoWrapper = document.getElementById("videoWrapper");
const video = document.getElementById("videoElement");
const backButton = document.getElementById("backButton");

const cheatOverlay = document.getElementById("cheatOverlay");
const cheatSequenceEl = document.getElementById("cheatSequence");
const cheatClear = document.getElementById("cheatClear");
const cheatSubmit = document.getElementById("cheatSubmit");
const cheatToVault = document.getElementById("cheatToVault");
const cheatClose = document.getElementById("cheatClose");
const cheatInfo = document.getElementById("cheatInfo");
const unlockFlash = document.getElementById("unlockFlash");

const vaultOverlay = document.getElementById("vaultOverlay");
const vaultList = document.getElementById("vaultList");
const vaultSub = document.getElementById("vaultSub");
const vaultBack = document.getElementById("vaultBack");
const vaultClose = document.getElementById("vaultClose");

const miniOverlay = document.getElementById("miniOverlay");
const miniClose = document.getElementById("miniClose");

/* add to home */
const addHomeBtn = document.getElementById("addHomeBtn");
const homeOverlay = document.getElementById("homeOverlay");
const homeClose = document.getElementById("homeClose");
const homeHow = document.getElementById("homeHow");
const homeSteps = document.getElementById("homeSteps");

/* ===== SOUND (click + password) ===== */
const CLICK_SFX_SRC = "sounds/click.mp3";
const PASS_SFX_SRC  = "sounds/password.mp3";

let clickSfx = null;
let passSfx = null;
let sfxPrimed = false;

function safePlay(audio) {
  if (!audio) return;
  try {
    audio.currentTime = 0;
    const p = audio.play();
    if (p && typeof p.catch === "function") p.catch(() => {});
  } catch {}
}

function primeSfxOnce() {
  if (sfxPrimed) return;
  sfxPrimed = true;

  clickSfx = new Audio(CLICK_SFX_SRC);
  clickSfx.preload = "auto";
  clickSfx.volume = 0.55;

  passSfx = new Audio(PASS_SFX_SRC);
  passSfx.preload = "auto";
  passSfx.volume = 0.75;

  // "Prime" on iOS/Safari: try a silent-ish play/pause in a user gesture.
  const prime = () => {
    try {
      if (clickSfx) { clickSfx.currentTime = 0; const p1 = clickSfx.play(); if (p1 && p1.then) p1.then(() => clickSfx.pause()).catch(() => {}); else clickSfx.pause(); }
      if (passSfx)  { passSfx.currentTime = 0;  const p2 = passSfx.play();  if (p2 && p2.then) p2.then(() => passSfx.pause()).catch(() => {});  else passSfx.pause(); }
    } catch {}
    window.removeEventListener("pointerdown", prime, true);
    window.removeEventListener("touchstart", prime, true);
    window.removeEventListener("keydown", prime, true);
  };

  window.addEventListener("pointerdown", prime, true);
  window.addEventListener("touchstart", prime, true);
  window.addEventListener("keydown", prime, true);
}
primeSfxOnce();

// Global click sound for ALL buttons EXCEPT the enter button
document.addEventListener("click", (e) => {
  const btn = e.target.closest("button");
  if (!btn) return;
  if (btn.disabled) return;

  // enter is special (no click sound)
  if (btn.id === "enterButton") return;

  safePlay(clickSfx);
}, true);

// Also cover pointerdown so it feels instant on mobile
document.addEventListener("pointerdown", (e) => {
  const btn = e.target.closest("button");
  if (!btn) return;
  if (btn.disabled) return;

  // enter is special (no click sound)
  if (btn.id === "enterButton") return;

  safePlay(clickSfx);
}, true);
/* ===== END SOUND ===== */

let currentAction = null;
let endedListener = null;

/**
 * Actions
 */
const actions = {
  "donovan": { src: "videos/video.mp4" },
  "gambosi": { src: "videos/skud.mp4" },
  "wasted":  { src: "videos/litty.mp4" },

  "tinny": { redirect: "scale/scale.html", sameTab: true },
  "bag":   { redirect: "game/boom.html", sameTab: true },
  "home":  { redirect: "../home.html", sameTab: true },
  "rick":  { redirect: "https://www.youtube.com/watch?v=dQw4w9WgXcQ", sameTab: false },
  "onway": { redirect: "stoneinfocus/stoneinfocus.html", sameTab: true },
  "deathstar": { redirect: "couchburnsimulator/couch.html", sameTab: true },

  "1millionfrogs": { src: "videos/1millionfrogs.mp4", mobileFill: true },
  "heavychest": { src: "videos/andre.mp4", mobileFill: true }
};

/**
 * Cheat sequences -> unlocks.
 * Tokens: U D L R A B
 */
const cheatUnlocks = {
  "U U D D L R L R B A": ["gambosi"],
  "U D U D A B": ["bag"],
  "A B A B": ["home"]
};

// ===== unlock storage =====
const UNLOCK_KEY = "portal_unlocked_codes_v1";

function loadUnlockedSet() {
  try {
    const raw = localStorage.getItem(UNLOCK_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return new Set(Array.isArray(arr) ? arr : []);
  } catch {
    return new Set();
  }
}

function saveUnlockedSet(set) {
  try { localStorage.setItem(UNLOCK_KEY, JSON.stringify([...set])); } catch {}
}

let unlocked = loadUnlockedSet();

// ===== state for showing cheat access =====
let hasWrongAttempt = false;

// ===== overlays =====
function hideUnlockFlash() {
  unlockFlash.textContent = "";
  unlockFlash.classList.remove("show");
  clearTimeout(hideUnlockFlash._t);
}
function showUnlockFlash(text) {
  unlockFlash.textContent = text;
  unlockFlash.classList.add("show");
  clearTimeout(hideUnlockFlash._t);
  hideUnlockFlash._t = setTimeout(() => {
    unlockFlash.classList.remove("show");
  }, 1200);
}

function closeAllOverlays() {
  cheatOverlay.style.display = "none";
  cheatOverlay.setAttribute("aria-hidden", "true");

  vaultOverlay.style.display = "none";
  vaultOverlay.setAttribute("aria-hidden", "true");

  miniOverlay.style.display = "none";
  miniOverlay.setAttribute("aria-hidden", "true");

  homeOverlay.style.display = "none";
  homeOverlay.setAttribute("aria-hidden", "true");

  hideUnlockFlash();
  requestAnimationFrame(() => passwordInput.focus());
}

function openCheatOverlay() {
  if (!hasWrongAttempt) return;

  // close keyboard on mobile
  try { passwordInput.blur(); } catch {}

  clearCheat();
  hideUnlockFlash();
  cheatOverlay.style.display = "flex";
  cheatOverlay.setAttribute("aria-hidden", "false");
}

function openVaultOverlay() {
  renderVault();
  vaultOverlay.style.display = "flex";
  vaultOverlay.setAttribute("aria-hidden", "false");
}

function openMini() {
  miniOverlay.style.display = "flex";
  miniOverlay.setAttribute("aria-hidden", "false");
}
function closeMini() {
  miniOverlay.style.display = "none";
  miniOverlay.setAttribute("aria-hidden", "true");
}

/* Add-to-home overlay */
function openHomeOverlay() {
  const ua = navigator.userAgent || "";
  const isIOS = /iPhone|iPad|iPod/i.test(ua);
  const isAndroid = /Android/i.test(ua);

  const shareSVG = `
    <svg class="share-icon" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 3v10" fill="none" stroke="black" stroke-width="2" stroke-linecap="round"/>
      <path d="M8.5 6.5 12 3l3.5 3.5" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M6 10v10h12V10" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  `;

  if (isIOS) {
    homeHow.textContent = "ios safari";
    homeSteps.innerHTML = `
      <div class="home-step">1) tap share ${shareSVG}</div>
      <div class="home-step">2) scroll → “add to home screen”</div>
      <div class="home-step">3) tap “add”</div>
    `;
  } else if (isAndroid) {
    homeHow.textContent = "android chrome";
    homeSteps.innerHTML = `
      <div class="home-step">1) tap the ⋮ menu</div>
      <div class="home-step">2) “add to home screen” (or “install app”)</div>
      <div class="home-step">3) confirm</div>
    `;
  } else {
    homeHow.textContent = "mobile";
    homeSteps.innerHTML = `<div class="home-step">open this page on your phone to add it to your home screen.</div>`;
  }

  homeOverlay.style.display = "flex";
  homeOverlay.setAttribute("aria-hidden", "false");
}

// close when clicking outside panels
cheatOverlay.addEventListener("pointerdown", (e) => { if (e.target === cheatOverlay) closeAllOverlays(); });
vaultOverlay.addEventListener("pointerdown", (e) => { if (e.target === vaultOverlay) closeAllOverlays(); });
miniOverlay.addEventListener("pointerdown", (e) => { if (e.target === miniOverlay) closeMini(); });
homeOverlay.addEventListener("pointerdown", (e) => { if (e.target === homeOverlay) closeAllOverlays(); });

// ===== shared action runner =====
function runActionByKey(keyRaw) {
  const key = (keyRaw || "").toLowerCase().trim();
  const action = actions[key];
  if (!action) return;

  passwordInput.disabled = true;
  closeAllOverlays();

  if (action.redirect) {
    const sameTab = action.sameTab !== false;
    passwordInput.disabled = false;
    passwordInput.value = "";
    setButtonsForInputState();

    if (sameTab) window.location.href = action.redirect;
    else window.open(action.redirect, "_blank");
    return;
  }

  currentAction = action;

  passwordScreen.style.opacity = 0;
  setTimeout(() => passwordScreen.style.display = "none", 400);

  contentPage.style.display = "block";
  playButton.classList.add("show");

  playButton.onclick = () => {
    playButton.classList.remove("show");

    videoWrapper.style.display = "block";
    videoWrapper.style.opacity = 0;
    backButton.classList.add("show");

    if (currentAction.mobileFill) videoWrapper.classList.add("mobile-fill");
    else videoWrapper.classList.remove("mobile-fill");

    video.src = currentAction.src + "?v=" + Date.now();
    video.currentTime = 0;

    requestAnimationFrame(() => {
      videoWrapper.style.opacity = 1;
      video.play().catch(() => {});
    });

    endedListener = resetToPassword;
    video.addEventListener("ended", endedListener, { once: true });
  };
}

// ===== vault render (clickable) =====
function renderVault() {
  const unlockables = ["bag", "home", "gambosi"];
  const unlockedNow = unlockables.filter(c => unlocked.has(c));

  if (unlockedNow.length === 0) {
    vaultSub.textContent = "nothing unlocked";
    vaultList.textContent = "—";
    return;
  }

  vaultSub.textContent = "unlocked passcodes:";
  vaultList.innerHTML = "";

  for (const code of unlockedNow) {
    const btn = document.createElement("button");
    btn.className = "vault-item";
    btn.type = "button";
    btn.textContent = code;
    btn.addEventListener("click", () => runActionByKey(code));
    vaultList.appendChild(btn);
  }
}

// ===== password flow =====
function resetToPassword() {
  if (endedListener) video.removeEventListener("ended", endedListener);
  video.pause();
  video.removeAttribute("src");
  video.load();

  backButton.classList.remove("show");

  contentPage.style.display = "none";
  passwordScreen.style.display = "flex";
  passwordScreen.style.opacity = 1;

  videoWrapper.style.display = "none";
  videoWrapper.style.opacity = 0;
  videoWrapper.classList.remove("mobile-fill");

  playButton.classList.remove("show");
  playButton.onclick = null;

  passwordInput.disabled = false;
  passwordInput.value = "";

  hasWrongAttempt = false;
  closeAllOverlays();

  setButtonsForInputState();
  passwordInput.focus();
}

/* BFCache restore */
function hardResetPasswordUI() {
  if (endedListener) video.removeEventListener("ended", endedListener);

  video.pause();
  video.removeAttribute("src");
  video.load();

  currentAction = null;
  endedListener = null;

  contentPage.style.display = "none";
  passwordScreen.style.display = "flex";
  passwordScreen.style.opacity = 1;

  videoWrapper.style.display = "none";
  videoWrapper.style.opacity = 0;
  videoWrapper.classList.remove("mobile-fill");

  playButton.classList.remove("show");
  playButton.onclick = null;
  backButton.classList.remove("show");

  passwordInput.disabled = false;
  passwordInput.value = "";
  passwordInput.setAttribute("value", "");

  hasWrongAttempt = false;
  closeAllOverlays();

  setButtonsForInputState();
  requestAnimationFrame(() => passwordInput.focus());
}

window.addEventListener("pageshow", () => hardResetPasswordUI());
window.addEventListener("pagehide", () => { passwordInput.disabled = false; });

backButton.onclick = resetToPassword;

// ===== Button visibility rules =====
// - typing => show ENTER
// - empty + before first wrong => show nothing
// - empty + after first wrong => show ?
function setButtonsForInputState() {
  const hasText = passwordInput.value.length > 0;

  if (hasText) {
    enterButton.classList.add("show");
    helpButton.classList.remove("show");
    addHomeBtn.style.display = "none";
    return;
  }

  // empty
  enterButton.classList.remove("show");

  if (hasWrongAttempt) {
    helpButton.classList.add("show");
    addHomeBtn.style.display = "";
  } else {
    helpButton.classList.remove("show");
    addHomeBtn.style.display = "none";
  }
}

// ===== enter flash ("nope") + password sfx =====
let enterFlashTimer = null;
let enterLock = false;

function flashNope(ms = 520) {
  clearTimeout(enterFlashTimer);
  enterLock = true;

  // play password sound on WRONG password
  safePlay(passSfx);

  helpButton.classList.remove("show");
  enterButton.textContent = "nope";
  enterButton.classList.add("show");
  enterButton.classList.add("flash");
  addHomeBtn.style.display = "none";

  enterFlashTimer = setTimeout(() => {
    enterButton.classList.remove("flash");
    enterButton.textContent = "enter ↵";
    enterLock = false;
    setButtonsForInputState();
  }, ms);
}

function tryPassword(playPasswordSound = true) {
  const key = passwordInput.value.toLowerCase().trim();
  const action = actions[key];

  // play password sound on EVERY attempt (keyboard enter or enter button)
  if (playPasswordSound) safePlay(passSfx);

  if (!action) {
    hasWrongAttempt = true;
    passwordInput.value = "";
    // don't double-play the sound here (already played above)
    flashNope(520);
    return;
  }

  runActionByKey(key);
}

passwordInput.addEventListener("input", () => { if (!enterLock) setButtonsForInputState(); });
passwordInput.addEventListener("keyup", () => { if (!enterLock) setButtonsForInputState(); });
passwordInput.addEventListener("change", () => { if (!enterLock) setButtonsForInputState(); });
passwordInput.addEventListener("focus", () => { if (!enterLock) setButtonsForInputState(); });

/* SUBMIT: only submits */
passwordForm.addEventListener("submit", (e) => {
  e.preventDefault();
  if (passwordInput.disabled) return;
  if (passwordInput.value.trim().length === 0) return;
  tryPassword(true);
});

/* Enter key works */
passwordInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    if (!passwordInput.disabled && passwordInput.value.trim().length > 0) {
      tryPassword(true);
    }
  }
});

/* iOS: make tapping ENTER always submit before blur (and play password sound) */
enterButton.addEventListener("pointerdown", (e) => {
  if (passwordInput.disabled) return;
  if (passwordInput.value.trim().length === 0) return;
  e.preventDefault();
  e.stopPropagation();
  tryPassword(true);
});

/* Help only opens cheats (and only after wrong attempt) + closes keyboard */
helpButton.addEventListener("pointerdown", (e) => {
  e.preventDefault();
  // close keyboard on mobile
  try { passwordInput.blur(); } catch {}
  openCheatOverlay();
});
helpButton.addEventListener("click", () => {
  try { passwordInput.blur(); } catch {}
  openCheatOverlay();
});

/* Tap outside after typing submits */
passwordScreen.addEventListener("pointerdown", (e) => {
  if (e.target === passwordInput || e.target === enterButton || e.target === helpButton || e.target === addHomeBtn) return;
  if (!passwordInput.disabled && passwordInput.value.trim().length > 0) {
    tryPassword(true);
  }
});

// ===== navigation =====
cheatToVault.addEventListener("click", () => {
  cheatOverlay.style.display = "none";
  cheatOverlay.setAttribute("aria-hidden", "true");
  openVaultOverlay();
});

cheatClose.addEventListener("click", () => closeAllOverlays());

cheatInfo.addEventListener("click", () => openMini());
miniClose.addEventListener("click", () => closeMini());

vaultBack.addEventListener("click", () => {
  vaultOverlay.style.display = "none";
  vaultOverlay.setAttribute("aria-hidden", "true");
  openCheatOverlay();
});

vaultClose.addEventListener("click", () => closeAllOverlays());

// add-to-home wiring
addHomeBtn.addEventListener("click", () => openHomeOverlay());
homeClose.addEventListener("click", () => closeAllOverlays());

// ===== cheat entry mechanics =====
let cheatTokens = [];

function renderCheatSequence() {
  cheatSequenceEl.textContent = cheatTokens.join(" ");
}

function pushCheatToken(tok) {
  cheatTokens.push(tok);
  if (cheatTokens.length > 16) cheatTokens.shift();
  renderCheatSequence();
}

function clearCheat() {
  cheatTokens = [];
  renderCheatSequence();
}

function submitCheat() {
  const seq = cheatTokens.join(" ").trim();
  const unlockList = cheatUnlocks[seq];

  if (!unlockList || unlockList.length === 0) {
    clearCheat();
    showUnlockFlash("nope");
    return;
  }

  const beforeSize = unlocked.size;

  for (const code of unlockList) {
    if (code === "home" || code === "bag" || code === "gambosi") unlocked.add(code);
  }
  saveUnlockedSet(unlocked);

  clearCheat();

  if (unlocked.size > beforeSize) showUnlockFlash("unlocked");
  else showUnlockFlash("already unlocked");
}

cheatClear.addEventListener("click", () => clearCheat());
cheatSubmit.addEventListener("click", () => submitCheat());

// tap tokens
cheatOverlay.addEventListener("click", (e) => {
  const btn = e.target.closest(".cheat-btn");
  if (!btn) return;
  pushCheatToken(btn.dataset.token);
});

// keyboard support: arrows + a + b + enter/backspace/escape
document.addEventListener("keydown", (e) => {
  if (miniOverlay.style.display === "flex") {
    if (e.key === "Escape") { e.preventDefault(); closeMini(); }
    return;
  }

  if (cheatOverlay.style.display !== "flex") return;

  if (e.key === "Escape") {
    e.preventDefault();
    closeAllOverlays();
    return;
  }

  if (e.key === "Backspace") {
    e.preventDefault();
    cheatTokens.pop();
    renderCheatSequence();
    return;
  }

  if (e.key === "Enter") {
    e.preventDefault();
    submitCheat();
    return;
  }

  let tok = null;
  if (e.key === "ArrowUp") tok = "U";
  else if (e.key === "ArrowDown") tok = "D";
  else if (e.key === "ArrowLeft") tok = "L";
  else if (e.key === "ArrowRight") tok = "R";
  else if (e.key.toLowerCase() === "a") tok = "A";
  else if (e.key.toLowerCase() === "b") tok = "B";

  if (tok) {
    e.preventDefault();
    pushCheatToken(tok);
  }
});

document.addEventListener("contextmenu", e => e.preventDefault());

// init
addHomeBtn.style.display = "none";
setButtonsForInputState();
</script>

</body>
</html>
