<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>put the bag in the bag</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<link rel="icon" type="image/png" href="./images/icon.png">
<style>
@font-face {
  font-family: "RuneScape UF";
  src: url("../../fonts/RuneScape-UF.woff2") format("woff2"),
       url("../../fonts/RuneScape-UF.woff") format("woff");
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  font-family: "RuneScape UF", Arial, sans-serif;
  cursor: url("../../images/cursor/cursor.png"), auto;
  background: #fff;
}


#topScores {
    position: absolute;
    top: 16px;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'RuneScape UF', Arial, sans-serif;
    color: #2d93ea;
    z-index: 50;
    display: flex;          /* keep layout intact */
    justify-content: center;
    gap: 4vw;
    white-space: nowrap;
    opacity: 0;             /* hidden initially */
    pointer-events: none;   /* prevent interaction while hidden */
    transition: opacity 0.5s;
}

#rotateNotice {
    display: none;               /* hidden by default */
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    background: #fff;
    color: #2d93ea;
    font-family: 'RuneScape UF', Arial, sans-serif;
    font-size: 5vw;
    text-align: center;
    line-height: 100vh;
    z-index: 9999;              /* above all game elements */
    opacity: 0;                 /* hidden initially */
    pointer-events: none;       /* ignore clicks when hidden */
    transition: opacity 0.5s ease; /* smooth fade in/out */
}

#rotateNotice.active {
    opacity: 1;                 /* visible */
    pointer-events: auto;       /* block interactions while visible */
}

/* Back Button */
.back-button {
  position: fixed;
  top: 8px;
  left: 8px;
  font-size: 24px;
  background: transparent;
  border: none;
  color: #2d93ea;
  font-family: "RuneScape UF", Arial, sans-serif;
  cursor: url("../../images/cursor/cursor-hover.png"), pointer;
  text-transform: lowercase;
  padding: 0;
  z-index: 100;
  opacity: 1;
  transition: opacity 0.5s ease;
  touch-action: none;
}

/* Music Button (like back button, bottom-left, hidden initially) */
.music-button {
  position: fixed;
  bottom: 8px;
  left: 8px;
  font-size: 24px;
  background: transparent;
  border: none;
  color: #2d93ea;
  font-family: "RuneScape UF", Arial, sans-serif;
  cursor: url("../../images/cursor/cursor-hover.png"), pointer;
  text-transform: lowercase;
  padding: 0;
  z-index: 400;
  opacity: 0;           /* hidden initially */
  transition: opacity 0.5s ease;
  touch-action: none;
}

/* Canvas */
canvas {
  display: block;
  margin: 0 auto;
  background: #ffffff;
}

/* Point Popup */
.point-popup {
  position: absolute;
  font-size: 28px;
  color: #2d93ea;
  font-family: "RuneScape UF", Arial, sans-serif;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s, transform 0.3s;
  z-index: 6;
}

/* Name Input Modal */
.name-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.95);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
  flex-direction: column;
  pointer-events: none;
}

.name-modal > * {
  pointer-events: auto;
}

.name-modal.show {
  display: flex;
}

.name-modal h2 {
  font-size: 36px;
  color: #2d93ea;
  margin-bottom: 8px;
}

.name-modal .final-score {
  font-size: 28px;
  color: #2d93ea;
  margin-bottom: 24px;
}

.name-modal input {
  font-family: "RuneScape UF", Arial, sans-serif;
  font-size: 24px;
  padding: 12px 16px;
  border: 2px solid #2d93ea;
  background: white;
  outline: none;
  text-align: center;
  width: 200px;
  margin-bottom: 16px;
}

.name-modal button {
  font-family: "RuneScape UF", Arial, sans-serif;
  font-size: 24px;
  padding: 12px 32px;
  border: 2px solid #2d93ea;
  background: #2d93ea;
  color: white;
  cursor: pointer;
  margin-top: 12px;
}

.name-modal button:hover {
  background: #1a7bd4;
}

/* Leaderboard */
#leaderboardBackdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.95);
  display: none;
  z-index: 9999;
  align-items: center;
  justify-content: center;
}

.leaderboard {
  background: white;
  border: 2px solid #2d93ea;
  padding: 24px;
  min-width: 280px;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
}

.leaderboard h3 {
  font-size: 28px;
  color: #2d93ea;
  margin: 0 0 16px 0;
  text-align: center;
}

.leaderboard-entry {
  display: flex;
  justify-content: space-between;
  font-size: 20px;
  color: #2d93ea;
  padding: 8px 0;
  border-bottom: 1px solid #e0e0e0;
}

.leaderboard-entry:last-child {
  border-bottom: none;
}

.leaderboard-entry .rank {
  width: 30px;
}

.leaderboard-entry .name {
  flex: 1;
  text-align: left;
  padding-left: 8px;
}

.leaderboard-entry .score {
  width: 60px;
  text-align: right;
}

.leaderboard-btn {
  position: fixed;
  top: 8px;
  right: 8px;
  font-size: 24px;
  background: transparent;
  border: none;
  color: #2d93ea;
  font-family: "RuneScape UF", Arial, sans-serif;
  cursor: pointer;
  z-index: 100;
}

.leaderboard-close {
  position: absolute;
  top: 8px;
  right: 12px;
  font-size: 24px;
  background: transparent;
  border: none;
  color: #2d93ea;
  font-family: "RuneScape UF", Arial, sans-serif;
  cursor: pointer;
}
/* SoundCloud Button */
.soundcloud-btn {
  position: fixed;
  bottom: 8px;
  right: 8px;
  font-size: 24px;
  background: transparent;
  border: none;
  color: #2d93ea;
  font-family: "RuneScape UF", Arial, sans-serif;
  cursor: url("../../images/cursor/cursor-hover.png"), pointer;
  text-transform: lowercase;
  padding: 0;
  z-index: 400;
  opacity: 1;
  transition: opacity 0.5s ease;
  touch-action: none;
}

</style>
</head>
<body>

<div id="rotateNotice">Please rotate your phone to portrait</div>
<button class="soundcloud-btn" id="soundcloudBtn" onclick="openSoundCloud()" style="display:none;">goodybag</button>
<button class="back-button" onclick="goBack()">← back</button>
<button class="music-button" id="musicToggle" style="bottom:8px; left:8px;">music toggle</button>

<audio id="bgMusic" src="/go/game/soundtrack.mp3" loop></audio>

<img id="playOverlay" src="play.png" style="
    position: absolute;
    top: 50%;
    left: 50%;
    max-width: 80%;
    max-height: 80%;
    transform: translate(-50%, -50%) scale(0.8);
    opacity: 0;
    transition: opacity 0.5s, transform 0.5s;
    z-index: 50;
    cursor: pointer;
">

<div id="overlayHighscore" style="position: absolute; top: 84%; left: 50%; transform: translateX(-50%); font-size: 28px; color: #2d93ea; z-index: 51; font-family: 'RuneScape UF', Arial, sans-serif; text-align: center; opacity: 0; transition: opacity 0.5s;"></div>
<div id="overlayLastScore" style="position: absolute; top: 90%; left: 50%; transform: translateX(-50%); font-size: 28px; color: #2d93ea; z-index: 51; font-family: 'RuneScape UF', Arial, sans-serif; text-align: center; opacity: 0; transition: opacity 0.5s;"></div>

<div id="topScores" style="position: absolute; top: 16px; left: 50%; transform: translateX(-50%); font-family: 'RuneScape UF', Arial, sans-serif; color: #2d93ea; z-index: 50; display: flex; justify-content: center; gap: 4vw; white-space: nowrap;">
  <div id="topCurrentScore">current score: 0</div>
  <div id="topHighscore">highscore: 0</div>
</div>

<button class="leaderboard-btn" onclick="toggleLeaderboard()">leaderboard</button>

<div class="name-modal" id="nameModal">
  <h2>game over!</h2>
  <div class="final-score" id="finalScore">score: 0</div>
  <input type="text" id="playerName" placeholder="enter name" maxlength="12" autocomplete="off">
  <button onclick="submitScore()">submit</button>
  <button onclick="playAgain()">play again</button>
</div>

<div id="leaderboardBackdrop">
  <div class="leaderboard" id="leaderboard">
    <button class="leaderboard-close" onclick="toggleLeaderboard()">×</button>
    <h3>leaderboard</h3>
    <div id="leaderboardEntries">loading...</div>
  </div>
</div>

<div id="mythicUnlockPopup" style="
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  text-align: center;
  font-family: 'RuneScape UF', Arial, sans-serif;
  color: #2d93ea;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s ease, transform 0.5s ease;
  z-index: 5000;
">
  <div style="font-size: 32px;">*mythic found*</div>
  <div style="font-size: 28px; margin-top: 14px;">
    soundtrack unlocked!
  </div>
</div>

<div id="goodybagBackdrop" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255,255,255,0.95);
  display: none;
  z-index: 10000;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  font-family: 'RuneScape UF', Arial, sans-serif;
  color: #2d93ea;
  text-align: center;
">
  <button id="soundtrackBtn" style="font-size:24px; margin:10px;" disabled>soundtracks</button>
  <button id="passwordBtn" style="font-size:24px; margin:10px;" disabled>passwords</button>
  <div id="goodybagContent" style="margin-top:20px; max-height:50vh; overflow-y:auto; font-size:18px;"></div>
  <button onclick="closeGoodybag()" style="margin-top:20px; font-size:20px;">close</button>
</div>

<canvas id="gameCanvas"></canvas>
<div class="point-popup" id="pointPopup">+1</div>
<div class="point-popup" id="funTextPopup"></div>

<script>
// ===================== GAME VARIABLES =====================
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const backButton = document.querySelector('.back-button');
const leaderboardBtn = document.querySelector('.leaderboard-btn');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
const COMMON_FUN_TEXTS = [
  "professional bagman",
  "bilbo baggin",
  "certified bag",
  "bag enjoyer",
  "bagtimus prime",
  "put the fries in the bag!",
  "bagonomotry",
  "bagzilla",
  "in the beginning there was bag...",
  "dusty bag",
  "phat bag",
  "middle class bag",
  "trapaholic",
  "luggage as bro",
  "probably not bag",
  "punching bag"
];

// ------------------- REWARD TRACKING -------------------
const REWARD_KEYS = {
    rare: 'rewardRareUnlocked',
    goated: 'rewardGoatedUnlocked',
    mythic: 'rewardMythicUnlocked'
};

// Ensure first-time unlock flags exist
Object.values(REWARD_KEYS).forEach(key => {
    if (localStorage.getItem(key) === null) localStorage.setItem(key, 'false');
});

const TIER_COLORS = {
    common: '#2d93ea',
    rare: '#1ccfcf',      // teal blue
    goated: 'gold',
    mythic: '#a855f7'     // glowing purple base
};

function unlockReward(tier) {
    const key = REWARD_KEYS[tier];
    if (!key || localStorage.getItem(key) === 'true') return; // already unlocked

    localStorage.setItem(key, 'true'); // mark unlocked

    // Visual feedback in the goody bag button
    const btn = document.getElementById('soundcloudBtn');
    if (btn) {
        btn.style.display = 'block';
        btn.textContent = `goodybag: new ${tier} reward!`;
        btn.style.fontWeight = 'bold';
        setTimeout(() => btn.textContent = 'goodybag', 3000);
    }

    // Optional: play sound or show popup
    showTextPopup(`First ${tier} bag! Reward unlocked!`, canvas.width/2, canvas.height/2, TIER_COLORS[tier]);
}

function maybeShowFunText(x, y, color) {
    if (Math.random() < 0.4) { // 40% chance
        const text = COMMON_FUN_TEXTS[
            Math.floor(Math.random() * COMMON_FUN_TEXTS.length)
        ];
        showTextPopup(text, x, y - 80, color);
    }
}

const hasUnlockedSoundtrack =
  localStorage.getItem('soundtrackUnlocked') === 'true';

// -------------------- FORCE RESET SOUNDTRACK --------------------
// Ensure everyone starts locked until first mythic bag
localStorage.removeItem('soundtrackUnlocked'); // clear old unlock
const soundcloudBtn = document.getElementById('soundcloudBtn');
if (soundcloudBtn) soundcloudBtn.style.display = 'none'; // hide button

// ===== SoundCloud link (change only this) =====
const SOUNDCLOUD_URL =
  "https://soundcloud.com/iggysmallls/put-the-bag-in-the-bag-official-soundtrack-gambosi-assisted/s-aKLrelhPjlt?si=ced42764564b4b1dbbaf8a6d1486e958&utm_source=clipboard&utm_medium=text&utm_campaign=social_sharing";

const GRAVITY = 0.32;
const LIFT = -6.9;
let SPEED = 3;
const START_SPEED = 3;      // speed when the game starts
const MAX_SPEED = 8;        // speed when score reaches MAX_SPEED_SCORE
const MAX_SPEED_SCORE = 500;
let SPRITE_SIZE = Math.round(canvas.height*0.12);

let ball = { x: Math.round(canvas.width*0.4), y: canvas.height/2, vy:0, spriteIndex:0, scaleX:1, scaleY:1 };
let hoops = [];
let score = 0;
let gameOver = false;
let gameStarted = false;
let glowPulse = 0;

// ===================== SPRITE LOADING =====================
const NUM_SPRITES = 25; // regular sprites
const sprites = [];
let assetsLoaded = false;

// Combine regular + mythic into one array
const allSpritePaths = [];
for (let i = 1; i <= NUM_SPRITES; i++) {
    allSpritePaths.push(`sprites/${String(i).padStart(2,'0')}.png`);
}
allSpritePaths.push('sprites/mythic1.png'); // mythic bag

// Load all sprites
let loadedCount = 0;
allSpritePaths.forEach((path, index) => {
    const img = new Image();
    img.onload = () => {
        loadedCount++;
        if (loadedCount === allSpritePaths.length) {
            assetsLoaded = true; // all loaded!
            console.log('All assets loaded!');
        }
    };
    img.src = path;
    // put in sprites array for regular sprites
    if (index < NUM_SPRITES) sprites.push(img);
    else window.mythicImg = img; // global mythic image
});

function getRarityRange(score) {
    if (score >= 1000) return { min: NUM_SPRITES, max: NUM_SPRITES }; // only mythic
    if (score >= 150) return { min: 19, max: NUM_SPRITES - 1 };       // goated + others
    if (score >= 100) return { min: 13, max: 18 };                    // rares
    if (score >= 50)  return { min: 8, max: 12 };                     // uncommon
    return { min: 0, max: 7 };                                        // commons
}

function maybeSpawnMythic(score) {
    if (score < 250) return false;   // no mythic before 250
    if (score >= 1000) return true;  // guaranteed mythic at 1000+

    // Linear ramp from 250 → 999
    // At 250 → 20% (0.2)
    // At 1000 → 100% (1.0)
    const minScore = 250;
    const maxScore = 999;
    const t = (score - minScore) / (maxScore - minScore); // 0→1
    const chance = 0.2 + t * 0.8;  // 0.2→1.0

    return Math.random() < chance;
}

function getWeightedSpriteIndex(first = false) {
    const used = new Set();
    used.add(ball.spriteIndex);
    hoops.forEach(h => used.add(h.spriteIndex));

// ===== PROGRESSIVE MYTHIC LOGIC =====
if (!first && maybeSpawnMythic(score)) {
    return NUM_SPRITES; // mythic bag
}

    // ===== NORMAL SPRITES =====
    let { min, max } = getRarityRange(score);

    if (first) { min = 0; max = 4; }

    max = Math.min(max, NUM_SPRITES - 1);

    const candidates = [];
    for (let i = min; i <= max; i++) {
        if (!used.has(i)) candidates.push(i);
    }

    if (candidates.length === 0) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    const newestBag = max;
    const weighted = [];
    candidates.forEach(i => {
        const weight = (i === newestBag) ? 5 : 2;
        for (let w = 0; w < weight; w++) weighted.push(i);
    });

    return weighted[Math.floor(Math.random() * weighted.length)];
}

const pointPopup=document.getElementById('pointPopup');
function showPopup(text, x, y, color = '#2d93ea', size = '28px', glow = false) {
    pointPopup.textContent = text;
    pointPopup.style.left = x + 'px';
    pointPopup.style.top = y + 'px';
    pointPopup.style.color = color;
    pointPopup.style.fontSize = size;
    pointPopup.style.opacity = 1;
    pointPopup.style.transform = "translateY(-30px)";

    // Apply glow effect if requested
    if (glow) {
        pointPopup.style.textShadow = `
            0 0 6px ${color},
            0 0 12px ${color},
            0 0 18px ${color}
        `;
    } else {
        pointPopup.style.textShadow = '';
    }

    setTimeout(() => {
        pointPopup.style.opacity = 0;
        pointPopup.style.transform = "translateY(-50px)";
        // reset textShadow for next popup
        pointPopup.style.textShadow = '';
        pointPopup.style.fontSize = '28px';
    }, 400);
}
const funTextPopup = document.getElementById('funTextPopup');
function showTextPopup(text, x, y, color = '#2d93ea', duration = 600) {
    const OFFSET_X = -35;   // ← move left
    const OFFSET_Y = -10;   // ↑ move up

    funTextPopup.textContent = text;
    funTextPopup.style.left = (x + OFFSET_X) + 'px';
    funTextPopup.style.top = (y + OFFSET_Y) + 'px';
    funTextPopup.style.color = color;
    funTextPopup.style.opacity = 1;
    funTextPopup.style.transform = "translateY(-30px)";

    setTimeout(() => {
        funTextPopup.style.opacity = 0;
        funTextPopup.style.transform = "translateY(-50px)";
    }, duration);
}

// +2 score popup (slightly delayed, same style)
function showMythicPlusTwo(x, y) {
    setTimeout(() => {
        pointPopup.textContent = '+2';
        pointPopup.style.left = (x + 20) + 'px'; // slight offset
        pointPopup.style.top = y + 'px';
        pointPopup.style.color = 'gold';
        pointPopup.style.opacity = 1;
        pointPopup.style.transform = "translateY(-30px)";

        setTimeout(() => {
            pointPopup.style.opacity = 0;
            pointPopup.style.transform = "translateY(-50px)";
            pointPopup.style.color = '#2d93ea'; // reset
        }, 400);
    }, 120);
}
// ===================== MYTHIC UNLOCK SYSTEM =====================

// Show center-screen "soundtrack unlocked" popup
function showMythicUnlockPopup() {
    const popup = document.getElementById('mythicUnlockPopup');

    popup.style.opacity = 1;
    popup.style.transform = 'translate(-50%, -50%) scale(1)';

    setTimeout(() => {
        popup.style.opacity = 0;
        popup.style.transform = 'translate(-50%, -50%) scale(0.9)';
    }, 2500);
}

// Permanently unlock soundtrack
function unlockSoundtrackIfNeeded() {
    if (localStorage.getItem('soundtrackUnlocked')) return;

    localStorage.setItem('soundtrackUnlocked', 'true');

    showMythicUnlockPopup();

    const soundcloudBtn = document.getElementById('soundcloudBtn');
    soundcloudBtn.style.display = 'block';
}

// Ensure soundtrack button stays unlocked on reload
window.addEventListener('load', () => {
    if (localStorage.getItem('soundtrackUnlocked')) {
        const soundcloudBtn = document.getElementById('soundcloudBtn');
        soundcloudBtn.style.display = 'block';
    }
});

function getPlayableHeight() {
    if (window.innerWidth <= 768) {
        return canvas.height * 0.95; // cut off bottom 20%
    }
    return canvas.height;
}

function addHoop(){
    const playableHeight = getPlayableHeight();

    // Get topScores height to prevent hoops overlapping
    const topScoresEl = document.getElementById('topScores');
    const topScoresHeight = topScoresEl.offsetHeight || 0;

    // verticalMargin: minimum distance from topScores and bottom of playable area
    const bottomMargin = playableHeight * 0.3; // 15% from bottom
    const topMargin = topScoresHeight + 100;     // 10px below topScores

    // y-coordinate for hoop spawn
    const y = Math.random() * (playableHeight - topMargin - bottomMargin) + topMargin;

    const spriteIndex = getWeightedSpriteIndex();
    hoops.push({x: canvas.width + 50, y, spriteIndex});
}

const playOverlay=document.getElementById('playOverlay');
const overlayHighscore=document.getElementById('overlayHighscore');
const overlayLastScore=document.getElementById('overlayLastScore');
const topCurrentScore=document.getElementById('topCurrentScore');
const topHighscore=document.getElementById('topHighscore');

function showTopScores() {
    const topScoresEl = document.getElementById('topScores');
    topScoresEl.style.opacity = 1;
    topScoresEl.style.pointerEvents = 'auto';
    updateTopScoreSize(); // << add this
}
function hideTopScores(){document.getElementById('topScores').style.opacity=0;document.getElementById('topScores').style.pointerEvents='none';}

function showMusicButton() {
    musicToggle.style.opacity = 1;
    if (bgMusic.readyState > 2 && !bgMusic.paused) {
        musicToggle.textContent = "music: on";
    } else {
        musicToggle.textContent = "music: off";
    }
}

function hideMusicButton() {
    musicToggle.style.opacity = 0;
}

function updateTopScores(){
    topCurrentScore.textContent="current score: "+score;
    const hs=localStorage.getItem('flappyBasketHighscore')||0;
    topHighscore.textContent="highscore: "+hs;
}

function showOverlay(showLastScore=false){
    playOverlay.style.opacity=1;
    playOverlay.style.transform="translate(-50%,-50%) scale(1)";
    playOverlay.style.pointerEvents = "auto"; 
    overlayHighscore.style.opacity=1;
    overlayHighscore.textContent="highscore: "+(localStorage.getItem('flappyBasketHighscore')||0);
    
    overlayLastScore.style.opacity = showLastScore ? 1 : 0;
    if(showLastScore){
        overlayLastScore.textContent = "last score: " + score;
    }
    
    hideTopScores();
    gameStarted = false;
    backButton.style.opacity = 1;
    leaderboardBtn.style.display = 'block';
    showMusicButton();
}

function hideOverlay(){
    playOverlay.style.opacity=0;
    playOverlay.style.transform="translate(-50%,-50%) scale(0.8)";
    playOverlay.style.pointerEvents = "none";
    overlayHighscore.style.opacity=0;
    overlayLastScore.style.opacity=0;
    showTopScores();
    hideMusicButton();
    setTimeout(()=>{ playOverlay.style.pointerEvents = "none"; }, 500);
}

setInterval(updateTopScores,100);
window.addEventListener('load', () => {
    showOverlay(false);
    updateTopScoreSize(); // ensure mobile font sizing applied
});

function openSoundCloud() {
    window.open(SOUNDCLOUD_URL, '_blank', 'noopener,noreferrer');
}

function startGame(){
    if(gameStarted||!assetsLoaded)return;
    hideOverlay();
    gameStarted=true;
    SPEED=3;
    hoops=[];
    score=0;
    gameOver=false;
    ball.x=Math.round(canvas.width*0.2);
    ball.y=canvas.height/2;
    ball.vy=0;
    ball.spriteIndex=getWeightedSpriteIndex(true);
    addHoop();
    loop();
    backButton.style.opacity = 0;
    leaderboardBtn.style.display = 'none'; 
    leaderboardBtn.style.zIndex = 100; 
    showTopScores(); 
    hideMusicButton();
}

// ------------------- GAME INPUT & AUTO-START -------------------
let touchActive = false;

function jump() {
    if (gameStarted && !gameOver) {
        ball.vy = 0;   // reset vertical velocity
        ball.vy += LIFT; // apply lift
    }
}

// Handles taps/clicks on canvas
function handleInput(e) {
    e.preventDefault();
    if (!gameStarted) {
        startGame();
        requestAnimationFrame(() => jump());
    } else {
        jump();      // only jump if game already started
    }
}

canvas.addEventListener('pointerdown', handleInput);
canvas.addEventListener('touchstart', handleInput, { passive: false });
canvas.addEventListener('mousedown', handleInput);

// Overlay click/touch to start game
playOverlay.addEventListener('click', (e) => { e.preventDefault(); startGame(); });
playOverlay.addEventListener('touchstart', (e) => { e.preventDefault(); startGame(); }, { passive: false });

// Prevent zooming/pinch scroll on mobile
document.addEventListener('gesturestart', (e) => e.preventDefault());
document.addEventListener('touchmove', (e) => { if (e.scale !== 1) e.preventDefault(); }, { passive: false });

// Disable scrolling
document.body.style.overflow = 'hidden';

function playAgain() {
  const nameModal = document.getElementById('nameModal');
  const leaderboardBackdrop = document.getElementById('leaderboardBackdrop');
  showTopScores(); 

  nameModal.classList.remove('show');
  leaderboardBackdrop.style.display = 'none';

  gameStarted = false;
  gameOver = false;

  overlayHighscore.style.opacity = 0;
  overlayLastScore.style.opacity = 0;

  soundcloudBtn.style.display = 'none';

  startGame();
}

function updateTopScoreSize() {
    const vw = window.innerWidth;
    if(vw <= 768){
        topCurrentScore.style.fontSize = '5.5vw';
        topHighscore.style.fontSize = '5.5vw';
    } else {
        topCurrentScore.style.fontSize = '2vw';
        topHighscore.style.fontSize = '2vw';
    }
}
window.addEventListener('resize',()=>{
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
  SPRITE_SIZE=Math.round(canvas.height*0.12);
  updateTopScoreSize();
});
window.addEventListener('load', updateTopScoreSize);

function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Update ball physics
    ball.vy += GRAVITY;
    ball.y += ball.vy;

    const playableHeight = getPlayableHeight();
    if (ball.y < 0 || ball.y > playableHeight) return endGame();

    // Speed scaling
    SPEED = START_SPEED + ((MAX_SPEED - START_SPEED) * Math.min(score, MAX_SPEED_SCORE) / MAX_SPEED_SCORE);

    glowPulse += 0.05;

    // Draw ball
    ctx.save();
    ctx.translate(ball.x, ball.y);
    ctx.scale(ball.scaleX, ball.scaleY);

    if (ball.spriteIndex === NUM_SPRITES) {
        // Mythic bag
        ctx.shadowColor = 'yellow';
        ctx.shadowBlur = 20 + Math.sin(glowPulse) * 10;
        ctx.drawImage(mythicImg, -SPRITE_SIZE/2, -SPRITE_SIZE/2, SPRITE_SIZE, SPRITE_SIZE);
        ctx.shadowBlur = 0;
    } else if (ball.spriteIndex >= 11) {
        // Rare bags
        const intensity = (ball.spriteIndex - 14) * 3 + Math.sin(glowPulse) * 4;
        ctx.shadowColor = 'rgba(255,215,0,0.8)';
        ctx.shadowBlur = intensity;
        ctx.drawImage(sprites[ball.spriteIndex], -SPRITE_SIZE/2, -SPRITE_SIZE/2, SPRITE_SIZE, SPRITE_SIZE);
        ctx.shadowBlur = 0;
    } else {
        // Common bags
        ctx.drawImage(sprites[ball.spriteIndex], -SPRITE_SIZE/2, -SPRITE_SIZE/2, SPRITE_SIZE, SPRITE_SIZE);
    }

    ctx.restore();

    // Draw hoops
    for (let i = hoops.length - 1; i >= 0; i--) {
        const h = hoops[i];
        h.x -= SPEED;

        if (h.spriteIndex === NUM_SPRITES) {
            // Mythic hoop
            ctx.shadowColor = 'yellow';
            ctx.shadowBlur = 20 + Math.sin(glowPulse) * 10;
            ctx.drawImage(mythicImg, h.x, h.y, SPRITE_SIZE, SPRITE_SIZE);
            ctx.shadowBlur = 0;
        } else if (h.spriteIndex >= 11) {
            const intensity = (h.spriteIndex - 14) * 3 + Math.sin(glowPulse) * 4;
            ctx.shadowColor = 'rgba(255,215,0,0.8)';
            ctx.shadowBlur = intensity;
            ctx.drawImage(sprites[h.spriteIndex], h.x, h.y, SPRITE_SIZE, SPRITE_SIZE);
            ctx.shadowBlur = 0;
        } else {
            ctx.drawImage(sprites[h.spriteIndex], h.x, h.y, SPRITE_SIZE, SPRITE_SIZE);
        }

        // Collision detection
        const hit =
            ball.x + SPRITE_SIZE/2 > h.x &&
            ball.x - SPRITE_SIZE/2 < h.x + SPRITE_SIZE &&
            ball.y + SPRITE_SIZE/2 > h.y &&
            ball.y - SPRITE_SIZE/2 < h.y + SPRITE_SIZE;

if (hit) {

    // ===== ULTIMATE BAG (mythic sprite) =====
    if (h.spriteIndex === NUM_SPRITES) {
            score += 5;
            const color = TIER_COLORS.mythic;

            showTextPopup('*mythic bag*', ball.x, ball.y - 80, color);
            showPopup('+5', ball.x, ball.y - 40, TIER_COLORS.mythic, '28px', true);

            unlockSoundtrackIfNeeded();
    }

    // ===== GOATED BAGS (20–25 → indices 19–24) =====
    else if (h.spriteIndex >= 19) {
            score += 3;
            const color = TIER_COLORS.goated;

            showTextPopup('goated bag', ball.x, ball.y - 80, color);
            showPopup('+3', ball.x, ball.y - 40, TIER_COLORS.goated, '28px', true);
            maybeShowFunText(ball.x, ball.y, color);
}

    // ===== rare BAGS (11–19 → indices 10–18) =====
    else if (h.spriteIndex >= 10) {
            score += 2;
            const color = TIER_COLORS.rare;

            showTextPopup('rare bag', ball.x, ball.y - 80, color);
            showPopup('+2', ball.x, ball.y - 40, TIER_COLORS.rare, '28px', true);
            maybeShowFunText(ball.x, ball.y, color);
}

    // ===== COMMON BAGS (01–10 → indices 0–9) =====
   else {
            score += 1;
            const color = TIER_COLORS.common;

            showPopup('+1', ball.x, ball.y - 40, TIER_COLORS.common, '28px', false);
            maybeShowFunText(ball.x, ball.y, color);
        }

    // Player becomes the bag they passed
    ball.spriteIndex = h.spriteIndex;

    // Remove hoop
    hoops.splice(i, 1);
    continue;
}

        // Missed hoop ends game
        if (h.x + SPRITE_SIZE < ball.x - 20) return endGame();
    }

    // Spawn new hoops
    if (hoops.length === 0 || hoops[hoops.length - 1].x < canvas.width - 420) addHoop();

    if (!gameOver) requestAnimationFrame(loop);
}

function endGame(){
  if(gameOver)return;
  gameOver=true;
  hideTopScores();
  const hs=localStorage.getItem('flappyBasketHighscore')||0;
  if(score>hs)localStorage.setItem('flappyBasketHighscore',score);
  backButton.style.opacity = 1;
  leaderboardBtn.style.display = 'block';
  showNameModal(score);
}

window.addEventListener('resize',()=>{
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
  SPRITE_SIZE=Math.round(canvas.height*0.12);
});

// ------------------- MUSIC -------------------
const bgMusic = document.getElementById('bgMusic');
bgMusic.volume = 0.5;
bgMusic.loop = true;


const musicToggle = document.getElementById('musicToggle');

musicToggle.style.opacity = 1;
musicToggle.textContent = "music: off"; // default state

// Start music on first user gesture (overlay click/touch)
function handleFirstUserGesture() {
    if(bgMusic.paused){
        bgMusic.play().then(() => {
            musicToggle.textContent = "music: on"; // update once music actually plays
        }).catch(()=>{});
    }
    window.removeEventListener('touchstart', handleFirstUserGesture);
    window.removeEventListener('mousedown', handleFirstUserGesture);
}

// Listen for first click/touch anywhere to unlock autoplay
window.addEventListener('touchstart', handleFirstUserGesture);
window.addEventListener('mousedown', handleFirstUserGesture);

// MUSIC TOGGLE
musicToggle.addEventListener('click', () => {
    if (bgMusic.paused) {
        bgMusic.play().catch(() => {});
        musicToggle.textContent = "music: on";
    } else {
        bgMusic.pause();
        musicToggle.textContent = "music: off";
    }
});
musicToggle.style.display = "block"; // ensure visible

// ------------------- PAUSE ON HIDE / CLOSE -------------------
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        bgMusic.pause();
        musicToggle.textContent = "music: off";
    } else if (!bgMusic.paused) {
        bgMusic.play().catch(()=>{});
        musicToggle.textContent = "music: on";
    }
});

window.addEventListener('beforeunload', () => {
    bgMusic.pause();
});

// ------------------- NAVIGATION -------------------
function goBack(){window.location.href="../index.html";}

// ================== LEADERBOARD ==================
(function initLeaderboard() {
  const nameModal = document.getElementById('nameModal');
  const finalScoreEl = document.getElementById('finalScore');
  const playerNameInput = document.getElementById('playerName');
  const leaderboardEl = document.getElementById('leaderboard');
  const leaderboardBackdrop = document.getElementById('leaderboardBackdrop');
  const leaderboardEntriesEl = document.getElementById('leaderboardEntries');

  const SUPABASE_URL = 'https://rlxtggsefecwcpgkjern.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_4mNOVz4GqFxtlJWOtzfXIQ_OaI1hLGT';
  let supabaseClient = null;

  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
  script.onload = function() {
    if (window.supabase) supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  };
  document.head.appendChild(script);

  async function fetchLeaderboard() {
    if (!supabaseClient) {
      leaderboardEntriesEl.innerHTML = '<div style="color:#999;font-size:16px;">leaderboard unavailable</div>';
      return [];
    }
    try {
      const { data, error } = await supabaseClient.from('highscores').select('*').order('score', { ascending: false }).limit(20);
      if (error) throw error;
      return data || [];
    } catch(e){ console.error(e); return []; }
  }

  async function saveScoreToDb(name, scoreVal) {
    if (!supabaseClient) return;
    try { await supabaseClient.from('highscores').insert([{ name, score: scoreVal }]); }
    catch(e){ console.error(e); }
  }

  function renderLeaderboard(entries) {
    if (!entries.length) {
      leaderboardEntriesEl.innerHTML = '<div style="color:#999;font-size:16px;">no scores yet</div>';
      return;
    }
    leaderboardEntriesEl.innerHTML = entries.map((entry,i)=>`
      <div class="leaderboard-entry">
        <span class="rank">${i+1}.</span>
        <span class="name">${entry.name}</span>
        <span class="score">${entry.score}</span>
      </div>
    `).join('');
  }

  window.toggleLeaderboard = async function() {
    const isOpen = leaderboardBackdrop.style.display === 'flex';
    if (isOpen) {
      leaderboardBackdrop.style.display = 'none';
    } else {
      leaderboardEntriesEl.innerHTML = 'loading...';
      leaderboardBackdrop.style.display = 'flex';
      const entries = await fetchLeaderboard();
      renderLeaderboard(entries);
    }
  };

window.showNameModal = function(finalScore) {
  finalScoreEl.textContent = 'score: ' + finalScore;
  playerNameInput.value = localStorage.getItem('playerName') || '';
  nameModal.classList.add('show');
  backButton.style.zIndex = 400;
  backButton.style.opacity = 1;
  leaderboardBtn.style.display = 'block';
  leaderboardBtn.style.zIndex = 300;
  setTimeout(()=>playerNameInput.focus(), 100);
  showMusicButton();

  // ✅ Only show soundtrack button if actually unlocked
  if (localStorage.getItem('soundtrackUnlocked') === 'true') {
      document.getElementById('soundcloudBtn').style.display = 'block';
  }
};

  window.submitScore = async function() {
    const name = playerNameInput.value.trim() || 'anonymous';
    localStorage.setItem('playerName', name);
    await saveScoreToDb(name, score);
    nameModal.classList.remove('show');
    showOverlay(true);
  };


// Try to lock the screen (optional, may fail)
function lockOrientation() {
    if (screen.orientation && screen.orientation.lock) {
        screen.orientation.lock('portrait').catch(err => {
            console.warn('Orientation lock failed (normal for mobile browsers):', err);
        });
    }
}

window.addEventListener('load', lockOrientation);
window.addEventListener('orientationchange', lockOrientation);

// Show rotate overlay in landscape (works everywhere)
function checkOrientation() {
    const rotateNotice = document.getElementById('rotateNotice');
    if (window.innerHeight < window.innerWidth) {
        rotateNotice.classList.add('active');
        gameStarted = false; // pause game if desired
    } else {
        rotateNotice.classList.remove('active');
    }
}

window.addEventListener('load', checkOrientation);
window.addEventListener('resize', checkOrientation);
window.addEventListener('orientationchange', checkOrientation);

// ===== TOP SCORES LAYOUT FIX FOR MOBILE =====
const topScoresEl = document.getElementById('topScores');
const topCurrentScore = document.getElementById('topCurrentScore');
const topHighscore = document.getElementById('topHighscore');

// Ensure inline layout and prevent font-loading jump
function fixTopScoresLayout() {
    topScoresEl.style.display = 'flex';
    topScoresEl.style.flexWrap = 'nowrap';
    topScoresEl.style.justifyContent = 'center';
    topScoresEl.style.gap = window.innerWidth <= 480 ? '3vw' : '4vw';
    topScoresEl.style.whiteSpace = 'nowrap';

    // Prevent jump by setting temporary min-width
    topCurrentScore.style.minWidth = 'max-content';
    topHighscore.style.minWidth = 'max-content';

    // Responsive font sizing
    updateTopScoreSize();
}

// Run once font is ready
document.fonts.ready.then(fixTopScoresLayout);

// Also run on window resize
window.addEventListener('resize', fixTopScoresLayout);

playerNameInput.addEventListener('keydown', e => { if(e.key==='Enter') window.submitScore(); });
})();

// ===== GOODYBAG SYSTEM =====
const goodybagBackdrop = document.getElementById('goodybagBackdrop');
const soundtrackBtn = document.getElementById('soundtrackBtn');
const passwordBtn = document.getElementById('passwordBtn');
const goodybagContent = document.getElementById('goodybagContent');
const goodybagBtn = document.getElementById('goodybagBtn');

const SOUNDTRACKS = {
    "soundtrack01": [
        "vivz portal - rezzett",
        "tell her nothing - young thug",
        "bag - mexikodro",
        "not many (soul version) - scribe & xylatu",
        "stick x need2 lc3 remix - jim legxacy",
        "bazooka - p.slxwly",
        "home - mazii7400prod glitzclub",
        "shalimar - inigo365 & skud gambosi"
    ]
};

// Open / Close functions
function openGoodybag() {
    goodybagBackdrop.style.display = 'flex';

    // Unlock buttons based on what bags player has found
    soundtrackBtn.disabled = localStorage.getItem(REWARD_KEYS.goated) !== 'true';
    passwordBtn.disabled = localStorage.getItem(REWARD_KEYS.mythic) !== 'true';

    // Default message if nothing unlocked
    if(!localStorage.getItem(REWARD_KEYS.goated) && !localStorage.getItem(REWARD_KEYS.mythic)) {
        goodybagContent.innerHTML = "<div>no goodies found yet...</div>";
    } else {
        goodybagContent.innerHTML = "";
    }
}
function closeGoodybag() { goodybagBackdrop.style.display = 'none'; }
goodybagBtn.addEventListener('click', openGoodybag);

// Soundtrack button
soundtrackBtn.addEventListener('click', () => {
    goodybagContent.innerHTML = '';
    if(localStorage.getItem(REWARD_KEYS.goated) !== 'true') {
        goodybagContent.innerHTML = '<div>No soundtracks unlocked yet...</div>';
        return;
    }
    for(const [name, tracks] of Object.entries(SOUNDTRACKS)) {
        const div = document.createElement('div');
        div.style.marginBottom = '15px';
        const header = document.createElement('div');
        header.style.fontWeight = 'bold';
        header.textContent = name;
        div.appendChild(header);
        const ul = document.createElement('ul');
        tracks.forEach(track => {
            const li = document.createElement('li');
            li.textContent = track;
            ul.appendChild(li);
        });
        div.appendChild(ul);
        goodybagContent.appendChild(div);
    }
});

// Password button
passwordBtn.addEventListener('click', () => {
    if(localStorage.getItem(REWARD_KEYS.mythic) !== 'true') {
        goodybagContent.innerHTML = '<div>No passwords unlocked yet...</div>';
        return;
    }
    goodybagContent.innerHTML = `<div>Your unlocked password: <strong>wasted</strong></div>`;
});

unlockReward = function(tier) {
    const btn = goodybagBtn;

    // ---- FIRST RARE BAG ----
    if (tier === 'rare' && localStorage.getItem(REWARD_KEYS.rare) !== 'true') {
        localStorage.setItem(REWARD_KEYS.rare, 'true');  // mark as unlocked
        if (btn) btn.style.display = 'block';           // show button permanently
        showTextPopup('*first rare bag!* goodybag unlocked!', canvas.width/2, canvas.height/2, TIER_COLORS.rare);
    }

    // ---- FIRST GOATED BAG ----
    if (tier === 'goated' && localStorage.getItem(REWARD_KEYS.goated) !== 'true') {
        localStorage.setItem(REWARD_KEYS.goated, 'true'); // mark as unlocked
        showTextPopup('*first goated bag!* soundtracks unlocked inside goodybag', canvas.width/2, canvas.height/2, TIER_COLORS.goated);
    }

    // ---- FIRST MYTHIC BAG ----
    if (tier === 'mythic' && localStorage.getItem(REWARD_KEYS.mythic) !== 'true') {
        localStorage.setItem(REWARD_KEYS.mythic, 'true'); // mark as unlocked
        showTextPopup('*first mythic bag!* passwords unlocked inside goodybag', canvas.width/2, canvas.height/2, TIER_COLORS.mythic);
    }

    // ---- ORIGINAL REWARD LOGIC (optional) ----
    if (typeof originalUnlockReward === 'function') originalUnlockReward(tier);
};

// ---- ENSURE GOODYBAG BUTTON STAYS VISIBLE AFTER RELOAD ----
window.addEventListener('load', () => {
    if (localStorage.getItem(REWARD_KEYS.rare) === 'true' && goodybagBtn) {
        goodybagBtn.style.display = 'block';
    }
});

</script>
</body>
</html>