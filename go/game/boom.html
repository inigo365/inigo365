<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>put the bag in the bag</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
@font-face {
  font-family: "RuneScape UF";
  src: url("../../fonts/RuneScape-UF.woff2") format("woff2"),
       url("../../fonts/RuneScape-UF.woff") format("woff");
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  font-family: "RuneScape UF", Arial, sans-serif;
  cursor: url("../../images/cursor/cursor.png"), auto;
  background: #fff;
}

canvas {
  display: block;
  margin: 0 auto;
  background: #ffffff;
}

.score {
  position: absolute;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 36px;
  color: #2d93ea;
  z-index: 5;
}

.start-text {
  position: absolute;
  top: 40%;
  left: 50%;
  transform: translateX(-50%);
  font-size: 36px;
  color: #2d93ea;
  text-align: center;
  z-index: 10;
}

.game-over {
  position: absolute;
  top: 40%;
  left: 50%;
  transform: translateX(-50%);
  text-align: center;
  display: none;
  z-index: 10;
}

.game-over h1 {
  font-size: 48px;
  color: #2d93ea;
  margin-bottom: 20px;
}

.game-over button {
  font-family: "RuneScape UF", Arial, sans-serif;
  font-size: 28px;
  padding: 8px 16px;
  cursor: url("../../images/cursor/cursor-hover.png"), pointer;
  background: #fff;
  border: 2px solid #2d93ea;
  color: #2d93ea;
}

.point-popup {
  position: absolute;
  font-size: 28px;
  color: #2d93ea;
  font-family: "RuneScape UF", Arial, sans-serif;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s, transform 0.3s;
  z-index: 6;
}
</style>
</head>

<body>

<div class="score" id="score">0</div>
<div class="start-text" id="startText">Click or Tap to Start</div>

<div class="game-over" id="gameOver">
  <h1>Game Over</h1>
  <p id="finalScore"></p>
  <p id="highScoreDisplay"></p>
  <button id="restartBtn">Restart</button>
</div>

<canvas id="gameCanvas"></canvas>
<div class="point-popup" id="pointPopup">+1</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Physics
const GRAVITY = 0.5;
const LIFT = -10;
const SPEED = 4;
const SPRITE_SIZE = 100;
const NUM_SPRITES = 25; // Updated for 25 sprites

// Game state
let ball = {
  x: 150,
  y: canvas.height / 2,
  vy: 0,
  spriteIndex: 0,
  scaleX: 1,
  scaleY: 1
};

let hoops = [];
let score = 0;
let gameOver = false;
let gameStarted = false;
let assetsLoaded = false;

// Load sprites
const sprites = [];
let loadedCount = 0;

for (let i = 1; i <= NUM_SPRITES; i++) {
  const img = new Image();
  img.onload = () => {
    loadedCount++;
    if (loadedCount === NUM_SPRITES) assetsLoaded = true;
  };
  img.src = `sprites/${String(i).padStart(2, '0')}.png`;
  sprites.push(img);
}

// ---------------------------
// RARITY LOGIC
// ---------------------------
function getRarityRange(score) {
  if (score >= 120) {
    return { min: 19, max: 24 }; // sprites 20â€“25
  }
  const tier = Math.floor(score / 30);
  return { min: 0, max: Math.min((tier + 1) * 5 - 1, NUM_SPRITES - 1) };
}

function weightedRandom(indices) {
  const weighted = [];
  indices.forEach(i => {
    const weight = NUM_SPRITES - i;
    for (let w = 0; w < weight; w++) weighted.push(i);
  });
  return weighted[Math.floor(Math.random() * weighted.length)];
}

function getUniqueSpriteIndex() {
  const used = new Set();
  used.add(ball.spriteIndex);
  hoops.forEach(h => used.add(h.spriteIndex));

  const { min, max } = getRarityRange(score);
  const candidates = [];
  for (let i = min; i <= max; i++) {
    if (!used.has(i)) candidates.push(i);
  }

  if (candidates.length === 0) return Math.floor(Math.random() * NUM_SPRITES);
  if (score >= 120) return candidates[Math.floor(Math.random() * candidates.length)];

  return weightedRandom(candidates);
}

// ---------------------------
// POPUP
// ---------------------------
const pointPopup = document.getElementById('pointPopup');
function showPopup(text, x, y) {
  pointPopup.textContent = text;
  pointPopup.style.left = x + 'px';
  pointPopup.style.top = y + 'px';
  pointPopup.style.opacity = 1;
  pointPopup.style.transform = "translateY(-30px)";
  setTimeout(() => {
    pointPopup.style.opacity = 0;
    pointPopup.style.transform = "translateY(-50px)";
  }, 400);
}

// ---------------------------
// HOOPS
// ---------------------------
function addHoop() {
  const y = Math.random() * (canvas.height - 240) + 120;
  hoops.push({
    x: canvas.width + 50,
    y,
    spriteIndex: getUniqueSpriteIndex()
  });
}

// ---------------------------
// START / JUMP
// ---------------------------
function startGame() {
  if (gameStarted || !assetsLoaded) return;

  gameStarted = true;
  document.getElementById('startText').style.display = 'none';
  hoops = [];
  score = 0;
  gameOver = false;
  ball.y = canvas.height / 2;
  ball.vy = 0;
  ball.spriteIndex = Math.floor(Math.random() * NUM_SPRITES);
  document.getElementById('score').textContent = score;
  addHoop();
  loop();
}
window.addEventListener('mousedown', startGame);
window.addEventListener('touchstart', startGame, { passive: true });

function jump() {
  if (gameStarted && !gameOver) ball.vy = LIFT;
}
window.addEventListener('mousedown', jump);
window.addEventListener('touchstart', jump, { passive: true });

// ---------------------------
// GAME LOOP
// ---------------------------
function loop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ball.vy += GRAVITY;
  ball.y += ball.vy;
  if (ball.y < 0 || ball.y > canvas.height) return endGame();

  ball.scaleX += (1 - ball.scaleX) * 0.15;
  ball.scaleY += (1 - ball.scaleY) * 0.15;

  ctx.save();
  ctx.translate(ball.x, ball.y);
  ctx.scale(ball.scaleX, ball.scaleY);
  ctx.drawImage(
    sprites[ball.spriteIndex],
    -SPRITE_SIZE / 2,
    -SPRITE_SIZE / 2,
    SPRITE_SIZE,
    SPRITE_SIZE
  );
  ctx.restore();

  for (let i = hoops.length - 1; i >= 0; i--) {
    const h = hoops[i];
    h.x -= SPEED;
    ctx.drawImage(sprites[h.spriteIndex], h.x, h.y, SPRITE_SIZE, SPRITE_SIZE);

    const hit =
      ball.x + SPRITE_SIZE / 2 > h.x &&
      ball.x - SPRITE_SIZE / 2 < h.x + SPRITE_SIZE &&
      ball.y + SPRITE_SIZE / 2 > h.y &&
      ball.y - SPRITE_SIZE / 2 < h.y + SPRITE_SIZE;

    if (hit) {
      score++;
      document.getElementById('score').textContent = score;
      showPopup('+1', ball.x, ball.y - 40);
      ball.spriteIndex = h.spriteIndex;
      ball.scaleX = 1.25;
      ball.scaleY = 0.75;
      hoops.splice(i, 1);
      continue;
    }

    if (h.x + SPRITE_SIZE < ball.x - 20) return endGame();
  }

  if (hoops.length === 0 || hoops[hoops.length - 1].x < canvas.width - 420) addHoop();

  if (!gameOver) requestAnimationFrame(loop);
}

// ---------------------------
// END GAME
// ---------------------------
function endGame() {
  if (gameOver) return;
  gameOver = true;
  showGameOver();
}

function showGameOver() {
  document.getElementById('finalScore').textContent = "Score: " + score;
  let hs = localStorage.getItem('flappyBasketHighscore') || 0;
  if (score > hs) localStorage.setItem('flappyBasketHighscore', score);
  document.getElementById('highScoreDisplay').textContent =
    "Highscore: " + Math.max(score, hs);
  document.getElementById('gameOver').style.display = 'block';
}

// ---------------------------
// RESTART
// ---------------------------
document.getElementById('restartBtn').addEventListener('click', () => {
  gameStarted = false;
  gameOver = false;
  hoops = [];
  document.getElementById('gameOver').style.display = 'none';
  document.getElementById('score').textContent = 0;
  document.getElementById('startText').style.display = 'block';
});

// ---------------------------
// RESIZE
// ---------------------------
window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});
</script>

</body>
</html>
