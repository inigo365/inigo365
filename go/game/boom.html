<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>bag</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
@font-face {
  font-family: "RuneScape UF";
  src: url("../../fonts/RuneScape-UF.woff2") format("woff2"),
       url("../../fonts/RuneScape-UF.woff") format("woff");
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  font-family: "RuneScape UF", Arial, sans-serif;
  cursor: url("../../images/cursor/cursor.png"), auto;
  background: #fff;
}

/* Back Button */
.back-button {
  position: fixed;
  top: 8px;
  left: 8px;
  font-size: 24px;
  background: transparent;
  border: none;
  color: #2d93ea;
  font-family: "RuneScape UF", Arial, sans-serif;
  cursor: url("../../images/cursor/cursor-hover.png"), pointer;
  text-transform: lowercase;
  padding: 0;
  z-index: 100;
  opacity: 1;
  transition: opacity 0.5s ease;
}

/* Canvas */
canvas {
  display: block;
  margin: 0 auto;
  background: #ffffff;
}

/* Point Popup */
.point-popup {
  position: absolute;
  font-size: 28px;
  color: #2d93ea;
  font-family: "RuneScape UF", Arial, sans-serif;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s, transform 0.3s;
  z-index: 6;
}
</style>
</head>

<body>

<button class="back-button" onclick="goBack()">‚Üê back</button>

<!-- Audio -->
<audio id="bgMusic" src="/go/game/soundtrack.mp3" loop></audio>

<img id="playOverlay" src="play.png" style="
    position: absolute;
    top: 50%;
    left: 50%;
    max-width: 80%;
    max-height: 80%;
    width: auto;
    height: auto;
    transform: translate(-50%, -50%) scale(0.8);
    opacity: 0;
    transition: opacity 0.5s, transform 0.5s;
    z-index: 50;
    cursor: pointer;
">

<!-- Bottom overlays -->
<div id="overlayHighscore" style="
    position: absolute;
    top: 84%;
    left: 50%;
    transform: translateX(-50%);
    font-size: 28px;
    color: #2d93ea;
    z-index: 51;
    font-family: 'RuneScape UF', Arial, sans-serif;
    text-align: center;
    opacity: 0;
    transition: opacity 0.5s;
"></div>

<div id="overlayLastScore" style="
    position: absolute;
    top: 90%;
    left: 50%;
    transform: translateX(-50%);
    font-size: 28px;
    color: #2d93ea;
    z-index: 51;
    font-family: 'RuneScape UF', Arial, sans-serif;
    text-align: center;
    opacity: 0;
    transition: opacity 0.5s;
"></div>

<!-- Top scores -->
<div id="topScores" style="
    position: absolute;
    top: 16px;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'RuneScape UF', Arial, sans-serif;
    color: #2d93ea;
    z-index: 50;
    display: flex;
    justify-content: center;
    gap: 4vw;
    white-space: nowrap;
">
    <div id="topCurrentScore">current score: 0</div>
    <div id="topHighscore">highscore: 0</div>
</div>

<canvas id="gameCanvas"></canvas>
<div class="point-popup" id="pointPopup">+1</div>

<script>
// ======= YOUR ORIGINAL GAME CODE REMAINS EXACTLY AS-IS =======

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const backButton = document.querySelector('.back-button');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Flappy Bird physics
const GRAVITY = 0.25;
const LIFT = -6.5;
let SPEED = 2; 
const MAX_SPEED = 5;
const SPEED_INCREMENT = 0.002; 
let SPRITE_SIZE = Math.round(canvas.height*0.12);

let ball = { x: Math.round(canvas.width*0.4), y: canvas.height/2, vy:0, spriteIndex:0, scaleX:1, scaleY:1 };
let hoops = [];
let score = 0;
let gameOver = false;
let gameStarted = false;
let assetsLoaded = false;
let glowPulse = 0;

const NUM_SPRITES = 25;
const sprites = [];
let loadedCount = 0;
for(let i=1;i<=NUM_SPRITES;i++){
  const img=new Image();
  img.onload=()=>{loadedCount++;if(loadedCount===NUM_SPRITES+1)assetsLoaded=true;};
  img.src=`sprites/${String(i).padStart(2,'0')}.png`;
  sprites.push(img);
}
const mythicImg=new Image();
mythicImg.src='sprites/mythic1.png';
mythicImg.onload=()=>{loadedCount++;if(loadedCount===NUM_SPRITES+1)assetsLoaded=true;};

function getRarityRange(score){if(score>=250)return {min:NUM_SPRITES,max:NUM_SPRITES}; let maxSprite=Math.min(4+Math.floor(score/5),NUM_SPRITES-1); return {min:0,max:maxSprite};}
function getWeightedSpriteIndex(first=false){const used=new Set();used.add(ball.spriteIndex);hoops.forEach(h=>used.add(h.spriteIndex));let {min,max}=getRarityRange(score);if(first){min=0; max=4;}const candidates=[];for(let i=min;i<=max;i++)if(!used.has(i))candidates.push(i);if(candidates.length===0)return Math.floor(Math.random()*(max-min+1))+min;if(score>=250)return NUM_SPRITES;const newestBag=max;const weighted=[];candidates.forEach(i=>{if(i===newestBag){for(let w=0;w<5;w++)weighted.push(i);}else{for(let w=0;w<2;w++)weighted.push(i);}});return weighted[Math.floor(Math.random()*weighted.length)];}

const pointPopup=document.getElementById('pointPopup');
function showPopup(text,x,y){pointPopup.textContent=text;pointPopup.style.left=x+'px';pointPopup.style.top=y+'px';pointPopup.style.opacity=1;pointPopup.style.transform="translateY(-30px)";setTimeout(()=>{pointPopup.style.opacity=0;pointPopup.style.transform="translateY(-50px)";},400);}

function addHoop(){const y=Math.random()*(canvas.height-240)+120;const spriteIndex=getWeightedSpriteIndex();hoops.push({x:canvas.width+50,y,spriteIndex});}

const playOverlay=document.getElementById('playOverlay');
const overlayHighscore=document.getElementById('overlayHighscore');
const overlayLastScore=document.getElementById('overlayLastScore');
const topCurrentScore=document.getElementById('topCurrentScore');
const topHighscore=document.getElementById('topHighscore');

function updateTopScores(){
    topCurrentScore.textContent="current score: "+score;
    const hs=localStorage.getItem('flappyBasketHighscore')||0;
    topHighscore.textContent="highscore: "+hs;
}

function showOverlay(showLastScore=false){
    playOverlay.style.opacity=1;
    playOverlay.style.transform="translate(-50%,-50%) scale(1)";
    overlayHighscore.style.opacity=1;
    overlayHighscore.textContent="highscore: "+(localStorage.getItem('flappyBasketHighscore')||0);
    topCurrentScore.style.display="none";
    topHighscore.style.display="none";
    if(showLastScore){overlayLastScore.textContent="last score: "+score; overlayLastScore.style.opacity=1;}
    else{overlayLastScore.style.opacity=0;}
    gameStarted=false;
    backButton.style.opacity = 1;
}

function hideOverlay(){
    playOverlay.style.opacity=0;
    playOverlay.style.transform="translate(-50%,-50%) scale(0.8)";
    overlayHighscore.style.opacity=0;
    overlayLastScore.style.opacity=0;
    topCurrentScore.style.display="flex";
    topHighscore.style.display="flex";
}

setInterval(updateTopScores,100);
window.addEventListener('load',()=>{showOverlay(false);});

function startGame(){
    if(gameStarted||!assetsLoaded)return;
    hideOverlay();
    gameStarted=true;
    SPEED=2;
    hoops=[];
    score=0;
    gameOver=false;
    ball.x=Math.round(canvas.width*0.4);
    ball.y=canvas.height/2;
    ball.vy=0;
    ball.spriteIndex=getWeightedSpriteIndex(true);
    addHoop();
    loop();
    backButton.style.opacity = 0;
}

playOverlay.addEventListener('click',startGame);
playOverlay.addEventListener('touchstart',startGame,{passive:true});

let touchActive = false;
function jump(){if(gameStarted&&!gameOver) ball.vy = LIFT;}
window.addEventListener('touchstart', (e)=>{e.preventDefault();touchActive=true;jump();},{passive:false});
window.addEventListener('touchend', ()=>{touchActive=false;});
window.addEventListener('mousedown', (e)=>{if(!touchActive) jump();});

function updateTopScoreSize() {
    const vw = window.innerWidth;
    if(vw <= 768){
        topCurrentScore.style.fontSize = '5.5vw';
        topHighscore.style.fontSize = '5.5vw';
    } else {
        topCurrentScore.style.fontSize = '2vw';
        topHighscore.style.fontSize = '2vw';
    }
}
window.addEventListener('resize', updateTopScoreSize);
window.addEventListener('load', updateTopScoreSize);

function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ball.vy+=GRAVITY;
  ball.y+=ball.vy;
  
  if(ball.y<0||ball.y>canvas.height)return endGame();
  
  if(score<250 && SPEED<MAX_SPEED) SPEED+=SPEED_INCREMENT;

  glowPulse+=0.05;
  
  ctx.save();
  ctx.translate(ball.x,ball.y);
  ctx.scale(ball.scaleX,ball.scaleY);
  if(ball.spriteIndex===NUM_SPRITES){ctx.shadowColor='yellow';ctx.shadowBlur=20+Math.sin(glowPulse)*10;ctx.drawImage(mythicImg,-SPRITE_SIZE/2,-SPRITE_SIZE/2,SPRITE_SIZE,SPRITE_SIZE);ctx.shadowBlur=0;}
  else if(ball.spriteIndex>=15){const intensity=(ball.spriteIndex-14)*3+Math.sin(glowPulse)*4;ctx.shadowColor='rgba(255,215,0,0.8)';ctx.shadowBlur=intensity;ctx.drawImage(sprites[ball.spriteIndex],-SPRITE_SIZE/2,-SPRITE_SIZE/2,SPRITE_SIZE,SPRITE_SIZE);ctx.shadowBlur=0;}
  else{ctx.drawImage(sprites[ball.spriteIndex],-SPRITE_SIZE/2,-SPRITE_SIZE/2,SPRITE_SIZE,SPRITE_SIZE);}
  ctx.restore();

  for(let i=hoops.length-1;i>=0;i--){
    const h=hoops[i];h.x-=SPEED;ctx.drawImage(sprites[h.spriteIndex],h.x,h.y,SPRITE_SIZE,SPRITE_SIZE);
    const hit = ball.x+SPRITE_SIZE/2>h.x && ball.x-SPRITE_SIZE/2<h.x+SPRITE_SIZE && ball.y+SPRITE_SIZE/2>h.y && ball.y-SPRITE_SIZE/2<h.y+SPRITE_SIZE;
    if(hit){score++;showPopup('+1',ball.x,ball.y-40);ball.spriteIndex=h.spriteIndex;hoops.splice(i,1);continue;}
    if(h.x+SPRITE_SIZE<ball.x-20) return endGame();
  }

  if(hoops.length===0 || hoops[hoops.length-1].x<canvas.width-420) addHoop();
  if(!gameOver) requestAnimationFrame(loop);
}

function endGame(){
  if(gameOver)return;
  gameOver=true;
  const hs=localStorage.getItem('flappyBasketHighscore')||0;
  if(score>hs)localStorage.setItem('flappyBasketHighscore',score);
  showOverlay(true);
  backButton.style.opacity = 1;
}

window.addEventListener('resize',()=>{
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
  SPRITE_SIZE=Math.round(canvas.height*0.12);
});

// ------------------- MUSIC FIX -------------------
const bgMusic = document.getElementById('bgMusic');
bgMusic.volume = 0.5;
bgMusic.loop = true;

// Create AudioContext to unlock autoplay on all devices
function startBgMusic() {
    try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        const track = audioCtx.createMediaElementSource(bgMusic);
        track.connect(audioCtx.destination);
        audioCtx.resume().then(() => bgMusic.play().catch(()=>{}));
    } catch(e){ bgMusic.play().catch(()=>{}); }

    window.removeEventListener('touchstart', startBgMusic);
    window.removeEventListener('mousedown', startBgMusic);
}

// Play immediately, fallback for mobile
startBgMusic();
window.addEventListener('touchstart', startBgMusic, {passive:true});
window.addEventListener('mousedown', startBgMusic);

// ------------------- NAVIGATION -------------------
function goBack(){window.location.href="../index.html";}
</script>
</body>
</html>
